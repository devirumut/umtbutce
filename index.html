<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bütçe CANLI V1</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root {
      --bg-body: #f1f5f9;
      --bg-card: #ffffff;
      --text-main: #1e293b;
      --primary: #2563eb;
      --success: #10b981;
      --danger: #ef4444;
      --border: #e2e8f0;
      --panel-width: 650px;
    }
    [data-theme="dark"] {
      --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; --border: #334155;
    }

    * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body { margin: 0; background: var(--bg-body); color: var(--text-main); }

    .app-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1rem 2rem; background: var(--bg-card); border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 1000;
    }

    /* Sol Panel 650px Sabit */
    .main-layout { display: flex; gap: 20px; padding: 20px; align-items: flex-start; }
    .left-panel { width: var(--panel-width); flex-shrink: 0; display: flex; flex-direction: column; gap: 15px; }
    
    .widget-card { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
    .widget-header { background: var(--primary); color: white; padding: 8px 12px; font-size: 0.8rem; font-weight: 600; }
    .crop-box { height: 160px; overflow: hidden; position: relative; }
    .crop-box iframe { width: 100%; height: 800px; border: none; position: absolute; top: -150px; }

    /* Bütçe Alanı */
    .budget-card { flex-grow: 1; background: var(--bg-card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    
    .session-indicator { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; font-weight: 600; }
    .status-led { width: 10px; height: 10px; border-radius: 50%; background: #ccc; }
    .status-active .status-led { background: var(--success); box-shadow: 0 0 8px var(--success); }

    .btn { cursor: pointer; border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; display: inline-flex; align-items: center; gap: 5px; background: var(--bg-card); color: var(--text-main); }
    .btn-primary { background: var(--primary); color: white; border: none; }
    
    .entry-row { display: grid; grid-template-columns: 40px 2fr 1fr 100px 100px 60px 80px 40px; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); align-items: center; }
    input, select { padding: 6px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); width: 100%; }
    
    .hidden { display: none !important; }
    .material-symbols-outlined { font-size: 20px; vertical-align: middle; }
  </style>
</head>
<body data-theme="light">

<div class="app-header">
  <div style="display: flex; align-items: center; gap: 20px;">
    <h2 style="margin: 0; color: var(--primary);">CANLI V1</h2>
    <div id="user-info" class="hidden" style="display: flex; align-items: center; gap: 10px;">
      <img id="user-img" style="width: 30px; border-radius: 50%;">
      <span id="user-email" style="font-size: 0.8rem;"></span>
    </div>
  </div>

  <div style="display: flex; align-items: center; gap: 10px;">
    <div id="session_badge" class="session-indicator hidden">
      <div class="status-led"></div>
      <span id="session_state">IDLE</span>
      <span id="session_countdown">--:--</span>
    </div>
    <button id="auth_btn" class="btn btn-primary"><span class="material-symbols-outlined">login</span> Google</button>
    <button id="btn_backup" class="btn hidden"><span class="material-symbols-outlined">cloud_upload</span></button>
    <button id="btn_logout" class="btn hidden"><span class="material-symbols-outlined">logout</span></button>
    <button id="btn_theme" class="btn"><span class="material-symbols-outlined">contrast</span></button>
  </div>
</div>

<div class="main-layout">
  <div class="left-panel">
    <div class="widget-card"><div class="widget-header">GRAM ALTIN</div><div class="crop-box"><iframe src="https://www.altinkaynak.com/canli-kurlar/altin"></iframe></div></div>
    <div class="widget-card"><div class="widget-header">ÇEYREK ALTIN</div><div class="crop-box"><iframe src="https://www.altinkaynak.com/canli-kurlar/altin"></iframe></div></div>
    <div class="widget-card"><div class="widget-header">DÖVİZ</div><div class="crop-box"><iframe src="https://www.altinkaynak.com/canli-kurlar/doviz"></iframe></div></div>
  </div>

  <div class="budget-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <div style="display: flex; gap: 10px; align-items: center;">
        <button id="btn_prev" class="btn"><span class="material-symbols-outlined">arrow_back</span></button>
        <b id="month-title" style="min-width: 120px; text-align: center;">---</b>
        <button id="btn_next" class="btn"><span class="material-symbols-outlined">arrow_forward</span></button>
      </div>
      <div style="display: flex; gap: 5px;">
        <button id="btn_chart" class="btn"><span class="material-symbols-outlined">bar_chart</span></button>
        <button id="btn_pdf" class="btn"><span class="material-symbols-outlined">picture_as_pdf</span></button>
        <button id="btn_settings" class="btn"><span class="material-symbols-outlined">settings</span></button>
      </div>
    </div>

    <input id="quick_input" placeholder="Hızlı ekle: 'Market 500 12 gider'" style="margin-bottom: 15px;">
    
    <div id="entries-container"></div>
    
    <button id="btn_add" class="btn btn-primary" style="width: 100%; margin-top: 15px; justify-content: center;">
      <span class="material-symbols-outlined">add</span> Yeni İşlem
    </button>
  </div>
</div>

<script>
  // Senin gönderdiğin tüm mantık değişkenleri
  let accessToken = null, driveFileId = null, tokenClient = null;
  let sessionActive = false, sessionTimer = null, countdownTimer = null, sessionExpireAt = 0;
  let viewDate = new Date(), entries = [], categories = ["Genel", "Gelir", "Kira", "Market", "Fatura"];
  const SESSION_TIMEOUT_MS = 15 * 60 * 1000;
  const DRIVE_BACKUP_NAME = "CANLI_V1_BACKUP.json";
  const STORAGE_PREFIX = "butce_";

  // --- Senin Gönderdiğin Drive ve Session Fonksiyonları ---
  async function driveRequest(url, options = {}) {
    if (!accessToken) throw new Error('NO_TOKEN');
    const res = await fetch(url, { ...options, headers: { ...(options.headers||{}), Authorization: `Bearer ${accessToken}` } });
    if (!res.ok) throw new Error(`DRIVE_${res.status}`);
    return res.headers.get('content-type')?.includes('json') ? res.json() : res.text();
  }

  async function syncToDrive(isAuto=false) {
    if (!driveFileId || !accessToken) return;
    const url = `https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=media`;
    const data = { months: {}, categories, theme: document.body.getAttribute('data-theme') };
    // LocalStorage'dan verileri topla
    for(let i=0; i<localStorage.length; i++){
      let k = localStorage.key(i);
      if(k.startsWith(STORAGE_PREFIX)) data.months[k] = JSON.parse(localStorage.getItem(k));
    }
    await driveRequest(url, { method:'PATCH', body: JSON.stringify(data) });
    if(!isAuto) alert("Buluta kaydedildi!");
  }

  function armSessionTimer() {
    clearTimeout(sessionTimer);
    sessionActive = true;
    sessionExpireAt = Date.now() + SESSION_TIMEOUT_MS;
    document.getElementById('session_badge').classList.remove('hidden');
    sessionTimer = setTimeout(() => { sessionActive = false; alert("Oturum doldu"); }, SESSION_TIMEOUT_MS);
    
    if(countdownTimer) clearInterval(countdownTimer);
    countdownTimer = setInterval(() => {
      let diff = sessionExpireAt - Date.now();
      if(diff <= 0) { clearInterval(countdownTimer); return; }
      let m = Math.floor(diff/60000), s = Math.floor((diff%60000)/1000);
      document.getElementById('session_countdown').textContent = `${m}:${s < 10 ? '0' : ''}${s}`;
    }, 1000);
  }

  // --- Render ve Başlatma ---
  function renderRows() {
    const container = document.getElementById('entries-container');
    container.innerHTML = '';
    entries.forEach((e, idx) => {
      const div = document.createElement('div');
      div.className = 'entry-row';
      div.innerHTML = `
        <span class="material-symbols-outlined" style="color:var(--primary)">payments</span>
        <input type="text" value="${e.name}" oninput="entries[${idx}].name=this.value; saveLocal()">
        <input type="number" value="${e.amount}" oninput="entries[${idx}].amount=this.value; saveLocal()">
        <select onchange="entries[${idx}].type=this.value; saveLocal()">
          <option value="gider" ${e.type=='gider'?'selected':''}>Gider</option>
          <option value="gelir" ${e.type=='gelir'?'selected':''}>Gelir</option>
        </select>
        <input type="text" value="${e.category}" list="cat-list">
        <input type="number" value="${e.billDay}">
        <button class="btn" style="border:none" onclick="entries[${idx}].status='paid'; saveLocal(); renderRows()"><span class="material-symbols-outlined" style="color:var(--success)">check_circle</span></button>
        <button class="btn" style="border:none" onclick="entries.splice(${idx},1); saveLocal(); renderRows()"><span class="material-symbols-outlined" style="color:var(--danger)">delete</span></button>
      `;
      container.appendChild(div);
    });
  }

  function saveLocal() {
    const key = STORAGE_PREFIX + document.getElementById('month-title').textContent;
    localStorage.setItem(key, JSON.stringify(entries));
  }

  function loadLocal() {
    const key = STORAGE_PREFIX + document.getElementById('month-title').textContent;
    entries = JSON.parse(localStorage.getItem(key)) || [];
    renderRows();
  }

  // --- Başlatıcılar ---
  window.onload = () => {
    const aylar = ["OCAK","ŞUBAT","MART","NİSAN","MAYIS","HAZİRAN","TEMMUZ","AĞUSTOS","EYLÜL","EKİM","KASIM","ARALIK"];
    const updateTitle = () => document.getElementById('month-title').textContent = aylar[viewDate.getMonth()] + "_" + viewDate.getFullYear();
    
    updateTitle();
    loadLocal();

    document.getElementById('btn_next').onclick = () => { viewDate.setMonth(viewDate.getMonth()+1); updateTitle(); loadLocal(); };
    document.getElementById('btn_prev').onclick = () => { viewDate.setMonth(viewDate.getMonth()-1); updateTitle(); loadLocal(); };
    document.getElementById('btn_add').onclick = () => { entries.push({name:'', amount:0, type:'gider', category:'Genel', billDay:1, status:'pending'}); renderRows(); };
    document.getElementById('btn_theme').onclick = () => {
      let t = document.body.getAttribute('data-theme') == 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', t);
    };

    // Auth Init
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: '874591165323-ktdp2ojebh4225v0335lvuk3pct8eraq.apps.googleusercontent.com', // Kendi ID'ni kontrol et
      scope: 'https://www.googleapis.com/auth/drive.appdata profile email',
      callback: (res) => {
        accessToken = res.access_token;
        document.getElementById('auth_btn').classList.add('hidden');
        document.getElementById('btn_backup').classList.remove('hidden');
        document.getElementById('btn_logout').classList.remove('hidden');
        armSessionTimer();
      }
    });

    document.getElementById('auth_btn').onclick = () => tokenClient.requestAccessToken();
    document.getElementById('btn_backup').onclick = () => syncToDrive();
  };
</script>

</body>
</html>
