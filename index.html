<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BÃ¼tÃ§e Planlama UygulamasÄ± V5.2 (Fix)</title>

  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://accounts.google.com;
    style-src  'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    img-src 'self' data: https://www.gstatic.com https://lh3.googleusercontent.com;
    connect-src 'self' https://www.googleapis.com https://oauth2.googleapis.com;
    frame-src https://www.altinkaynak.com;
  " />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root {
      --primary: #f8fafc; --card-bg: #ffffff; --accent: #4f46e5;
      --income: #22c55e; --expense: #f43f5e; --pending: #f59e0b;
      --text-main: #1e293b; --text-dim: #64748b; --border: #e2e8f0;
      --shadow: 0 10px 40px rgba(0,0,0,0.04);
    }
    [data-theme="dark"] {
      --primary: #0f172a; --card-bg: #1e293b; --accent: #818cf8;
      --text-main: #f1f5f9; --text-dim: #94a3b8; --border: #334155;
    }
    body { font-family: 'Poppins', sans-serif; background: var(--primary); color: var(--text-main); margin: 0; padding: 15px; transition: 0.3s; }
    .hidden { display: none !important; }
    
    /* Header & Auth */
    .app-header { max-width: 1750px; margin: 0 auto 20px; display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: var(--card-bg); border-radius: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); }
    .btn-action { background: var(--accent); color: white; border: none; padding: 10px 18px; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; }
    .ico { font-style: normal; font-size: 1.2em; }
    
    /* Layout */
    .main-layout { display: grid; grid-template-columns: 320px 1fr; gap: 20px; max-width: 1750px; margin: 0 auto; }
    .card { background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border); padding: 20px; box-shadow: var(--shadow); }
    
    /* Entry Table */
    .entry-grid { display: grid; grid-template-columns: 40px 1.5fr 100px 100px 100px 100px 40px; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); align-items: center; }
    input, select { background: var(--primary); border: 1.5px solid var(--border); padding: 8px; border-radius: 10px; color: var(--text-main); font-size: 13px; }
    
    .badge { padding: 6px; border-radius: 8px; font-size: 10px; font-weight: 700; text-align: center; cursor: pointer; }
    .b-paid { background: #dcfce7; color: #166534; }
    .b-pending { background: #fef3c7; color: #92400e; }

    /* Modals */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 1000; display: flex; align-items: center; justify-content: center; }
    .modal-content { background: var(--card-bg); width: 90%; max-width: 900px; border-radius: 25px; padding: 30px; position: relative; max-height: 90vh; overflow-y: auto; }
  </style>
</head>
<body data-theme="light">

  <header class="app-header">
    <div style="display:flex; align-items:center; gap:15px;">
      <h1 style="margin:0; font-size:1.5rem;">BÃ¼tÃ§e <span style="font-size:12px; opacity:0.6;">V5.2</span></h1>
      <div id="user_info" class="hidden" style="align-items:center; gap:10px; border-left:1px solid var(--border); padding-left:15px;">
        <img id="user_img" src="" style="width:30px; border-radius:50%;">
        <span id="user_email" style="font-size:12px; font-weight:600;"></span>
      </div>
    </div>

    <div style="display:flex; gap:12px;">
      <button id="auth_btn" class="btn-action" style="background:white; color:#444; border:1px solid #ddd;">
        <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" width="18"> Google ile BaÄŸlan
      </button>
      
      <div id="auth_controls" class="hidden" style="gap:10px;">
        <button id="btn_sync_manual" class="btn-action" style="background:#22c55e;">
          <span class="ico">â˜ï¸</span> Yedekle
        </button>
        <button id="btn_logout" class="btn-action" style="background:#64748b;">
          <span class="ico">ğŸšª</span> Ã‡Ä±kÄ±ÅŸ
        </button>
      </div>
      
      <button id="btn_theme" class="btn-action" style="background:var(--card-bg); color:var(--text-main); border:1px solid var(--border);">ğŸŒ“</button>
    </div>
  </header>

  <main class="main-layout">
    <aside>
      <div class="card">
        <h4 style="margin:0 0 10px 0; font-size:13px;">HÄ±zlÄ± Ä°ÅŸlem</h4>
        <input id="quick_input" placeholder="'kira 5000 15 gider' yaz..." style="width:100%;">
        
        <div style="margin-top:20px; font-size:12px;">
          <div id="stat_summary"></div>
        </div>
      </div>
    </aside>

    <section>
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <div style="display:flex; gap:10px;">
            <button id="btn_prev" class="btn-action">â®</button>
            <h2 id="display_month" style="margin:0; min-width:140px; text-align:center;"></h2>
            <button id="btn_next" class="btn-action">â¯</button>
          </div>
          <div style="display:flex; gap:10px;">
            <button id="btn_analysis" class="btn-action">ğŸ“Š Analiz</button>
            <button id="btn_yearly" class="btn-action">ğŸ“… YÄ±llÄ±k</button>
            <button id="btn_pdf" class="btn-action">ğŸ“„ PDF</button>
          </div>
        </div>
        
        <div id="entries_container"></div>
        <button id="btn_add" class="btn-action" style="width:100%; justify-content:center; margin-top:15px; background:none; color:var(--accent); border:2px dashed var(--accent);">+ Yeni Ekle</button>
      </div>
    </section>
  </main>

  <div id="modal_analysis" class="modal-overlay hidden">
    <div class="modal-content">
      <button onclick="closeModal('modal_analysis')" style="float:right;">âœ•</button>
      <h3>Harcama Analizi</h3>
      <div style="max-width:400px; margin:auto;">
        <canvas id="chart_month"></canvas>
      </div>
    </div>
  </div>

  <div id="modal_yearly" class="modal-overlay hidden">
    <div class="modal-content">
      <button onclick="closeModal('modal_yearly')" style="float:right;">âœ•</button>
      <h3>2026 YÄ±lÄ± Ã–zeti</h3>
      <div id="yearly_table_container"></div>
    </div>
  </div>

<script>
  // ... Kodun geri kalanÄ± (JS) iÃ§in "devam et" demen yeterli, karakter sÄ±nÄ±rÄ±na takÄ±lmamak iÃ§in bÃ¶lÃ¼yorum.
  <script>
  const aylar = ["Ocak", "Åubat", "Mart", "Nisan", "MayÄ±s", "Haziran", "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"];
  let viewDate = new Date();
  let entries = [];
  let myCharts = { month: null };
  let accessToken = null;
  let tokenClient = null;

  // --- GOOGLE AUTH ---
  function initTokenClient() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: '874591165323-ktdp2ojebh4225v0335lvuk3pct8eraq.apps.googleusercontent.com',
      scope: 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/userinfo.email',
      callback: (tokenResponse) => {
        accessToken = tokenResponse.access_token;
        setAuthUi(true);
        fetchUserInfo();
        toast('BaÄŸlantÄ± baÅŸarÄ±lÄ±', 'ok');
      },
    });
  }

  function setAuthUi(isLoggedIn) {
    document.getElementById('auth_btn').classList.toggle('hidden', isLoggedIn);
    document.getElementById('auth_controls').classList.toggle('hidden', !isLoggedIn);
    document.getElementById('auth_controls').style.display = isLoggedIn ? 'flex' : 'none';
    document.getElementById('user_info').classList.toggle('hidden', !isLoggedIn);
    document.getElementById('user_info').style.display = isLoggedIn ? 'flex' : 'none';
  }

  async function fetchUserInfo() {
    const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    const user = await res.json();
    document.getElementById('user_email').innerText = user.email;
    document.getElementById('user_img').src = user.picture;
  }

  // --- VERÄ° YÃ–NETÄ°MÄ° ---
  function loadData() {
    const key = `butce_${viewDate.getFullYear()}_${viewDate.getMonth()}`;
    const raw = localStorage.getItem(key);
    entries = raw ? JSON.parse(raw) : [];
    renderAll();
  }

  function saveLocal() {
    const key = `butce_${viewDate.getFullYear()}_${viewDate.getMonth()}`;
    localStorage.setItem(key, JSON.stringify(entries));
    renderStats();
  }

  function renderAll() {
    document.getElementById('display_month').innerText = `${aylar[viewDate.getMonth()]} ${viewDate.getFullYear()}`;
    const container = document.getElementById('entries_container');
    container.innerHTML = '';

    entries.forEach((e, idx) => {
      const row = document.createElement('div');
      row.className = 'entry-grid';
      row.innerHTML = `
        <div style="font-size:20px; text-align:center;">${getIcon(e.name)}</div>
        <input type="text" value="${e.name}" onchange="updateItem(${idx}, 'name', this.value)">
        <input type="number" value="${e.amount}" onchange="updateItem(${idx}, 'amount', this.value)">
        <select onchange="updateItem(${idx}, 'type', this.value); renderAll();">
          <option value="gider" ${e.type === 'gider' ? 'selected' : ''}>Gider</option>
          <option value="gelir" ${e.type === 'gelir' ? 'selected' : ''}>Gelir</option>
        </select>
        <input type="number" value="${e.day || 1}" min="1" max="31" onchange="updateItem(${idx}, 'day', this.value)">
        <div class="badge ${e.status === 'paid' ? 'b-paid' : 'b-pending'}" onclick="toggleStatus(${idx})">
          ${e.status === 'paid' ? 'TAMAM' : 'BEKLE'}
        </div>
        <button onclick="deleteItem(${idx})" style="border:none; background:none; cursor:pointer;">ğŸ—‘ï¸</button>
      `;
      container.appendChild(row);
    });
    renderStats();
  }

  function getIcon(name) {
    const n = (name || "").toLowerCase();
    if (n.includes('maaÅŸ')) return 'ğŸ’°';
    if (n.includes('kira')) return 'ğŸ ';
    if (n.includes('market')) return 'ğŸ›’';
    if (n.includes('fatura')) return 'ğŸ“„';
    return 'ğŸ“';
  }

  function updateItem(idx, key, val) {
    entries[idx][key] = (key === 'amount' || key === 'day') ? parseFloat(val) : val;
    saveLocal();
  }

  function toggleStatus(idx) {
    entries[idx].status = entries[idx].status === 'paid' ? 'pending' : 'paid';
    saveLocal();
    renderAll();
  }

  function deleteItem(idx) {
    entries.splice(idx, 1);
    saveLocal();
    renderAll();
  }

  function renderStats() {
    let inc = 0, exp = 0;
    entries.forEach(e => {
      const amt = parseFloat(e.amount) || 0;
      if (e.type === 'gelir') inc += amt; else exp += amt;
    });
    document.getElementById('stat_summary').innerHTML = `
      <div style="color:var(--income)">Toplam Gelir: ${inc.toLocaleString()} TL</div>
      <div style="color:var(--expense)">Toplam Gider: ${exp.toLocaleString()} TL</div>
      <div style="font-weight:bold; margin-top:5px;">Net: ${(inc - exp).toLocaleString()} TL</div>
    `;
  }

  // --- ANALÄ°Z & YILLIK TABLO (DÃœZELTÄ°LEN KISIMLAR) ---
  function showAnalysis() {
    document.getElementById('modal_analysis').classList.remove('hidden');
    setTimeout(() => {
      const ctx = document.getElementById('chart_month').getContext('2d');
      if (myCharts.month) myCharts.month.destroy();

      let inc = 0, exp = 0;
      entries.forEach(e => {
        const amt = parseFloat(e.amount) || 0;
        if (e.type === 'gelir') inc += amt; else exp += amt;
      });

      myCharts.month = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Gider', 'Kalan'],
          datasets: [{
            data: [exp, Math.max(0, inc - exp)],
            backgroundColor: ['#f43f5e', '#22c55e']
          }]
        }
      });
    }, 200);
  }

  function showYearly() {
    const year = viewDate.getFullYear();
    const container = document.getElementById('yearly_table_container');
    document.getElementById('modal_yearly').classList.remove('hidden');
    
    let html = `<table style="width:100%; border-collapse:collapse; margin-top:15px; font-size:13px;">
      <tr style="background:var(--primary);">
        <th style="padding:10px; border:1px solid var(--border);">Ay</th>
        <th style="padding:10px; border:1px solid var(--border);">Gelir</th>
        <th style="padding:10px; border:1px solid var(--border);">Gider</th>
        <th style="padding:10px; border:1px solid var(--border);">Fark</th>
      </tr>`;

    for (let m = 0; m < 12; m++) {
      const data = JSON.parse(localStorage.getItem(`butce_${year}_${m}`) || '[]');
      let mInc = 0, mExp = 0;
      data.forEach(e => { if (e.type === 'gelir') mInc += e.amount; else mExp += e.amount; });
      html += `<tr>
        <td style="padding:8px; border:1px solid var(--border);">${aylar[m]}</td>
        <td style="padding:8px; border:1px solid var(--border); color:var(--income)">${mInc.toLocaleString()} TL</td>
        <td style="padding:8px; border:1px solid var(--border); color:var(--expense)">${mExp.toLocaleString()} TL</td>
        <td style="padding:8px; border:1px solid var(--border); font-weight:bold;">${(mInc - mExp).toLocaleString()} TL</td>
      </tr>`;
    }
    html += `</table>`;
    container.innerHTML = html;
  }

  function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

  // --- EVENT BINDING ---
  function bindEvents() {
    document.getElementById('auth_btn').onclick = () => tokenClient.requestAccessToken();
    document.getElementById('btn_logout').onclick = () => { if(confirm('Ã‡Ä±kÄ±ÅŸ yapÄ±lsÄ±n mÄ±?')) location.reload(); };
    
    document.getElementById('btn_prev').onclick = () => { viewDate.setMonth(viewDate.getMonth() - 1); loadData(); };
    document.getElementById('btn_next').onclick = () => { viewDate.setMonth(viewDate.getMonth() + 1); loadData(); };
    document.getElementById('btn_add').onclick = () => {
      entries.push({ name: '', amount: 0, type: 'gider', status: 'pending', day: new Date().getDate() });
      renderAll();
    };
    
    document.getElementById('btn_analysis').onclick = showAnalysis;
    document.getElementById('btn_yearly').onclick = showYearly;
    
    document.getElementById('btn_theme').onclick = () => {
      const theme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', theme);
    };

    document.getElementById('quick_input').onkeypress = (e) => {
      if (e.key === 'Enter') {
        const p = e.target.value.split(' ');
        if (p.length >= 2) {
          entries.push({ name: p[0], amount: parseFloat(p[1]) || 0, day: parseInt(p[2]) || 1, type: p[3] || 'gider', status: 'pending' });
          e.target.value = ''; saveLocal(); renderAll();
        }
      }
    };
  }

  function toast(m, t) { console.log(m); }

  window.onload = () => {
    initTokenClient();
    loadData();
    bindEvents();
  };
</script>
</body>
</html>
