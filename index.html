<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BÃ¼tÃ§e Planlama UygulamasÄ± V5.2 (Single File)</title>

  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'nonce-umtdvr_v52' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://accounts.google.com;
    style-src  'self' 'nonce-umtdvr_v52' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    img-src 'self' data: https://www.gstatic.com https://lh3.googleusercontent.com;
    connect-src 'self' https://www.googleapis.com https://oauth2.googleapis.com;
    frame-src https://www.altinkaynak.com;
    base-uri 'self';
    form-action 'self';
    object-src 'none';
    frame-ancestors 'none';
    upgrade-insecure-requests;
  " />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" nonce="umtdvr_v52"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" nonce="umtdvr_v52"></script>
  <script src="https://accounts.google.com/gsi/client" async defer nonce="umtdvr_v52"></script>

  <style nonce="umtdvr_v52">
    :root {
      --primary: #f8fafc; --card-bg: #ffffff; --accent: #4f46e5;
      --income: #22c55e; --expense: #f43f5e; --pending: #f59e0b; --overdue: #ef4444;
      --text-main: #1e293b; --text-dim: #64748b; --border: #e2e8f0; --header-bg: #f1f5f9;
      --shadow: 0 10px 40px rgba(0,0,0,0.04);
    }
    [data-theme="dark"] {
      --primary: #0f172a; --card-bg: #1e293b; --accent: #818cf8;
      --text-main: #f1f5f9; --text-dim: #94a3b8; --border: #334155; --header-bg: #334155;
      --shadow: 0 10px 40px rgba(0,0,0,0.25);
    }
    * { box-sizing: border-box; outline: none; }
    body {
      font-family: 'Poppins', sans-serif; background-color: var(--primary); color: var(--text-main);
      margin: 0; padding: 10px; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; min-height: 100vh;
    }
    .hidden { display: none !important; }
    .app-header {
      width: 100%; max-width: 1750px; display: flex; justify-content: space-between; align-items: center;
      padding: 10px 25px; background: var(--card-bg); border-radius: 15px; margin-bottom: 15px;
      box-shadow: var(--shadow); border: 1px solid var(--border);
    }
    .header-left, .header-right { display: flex; align-items: center; gap: 12px; }
    .google-btn {
      display: flex; align-items: center; gap: 10px; background: white; color: #3c4043;
      border: 1px solid #dadce0; padding: 8px 16px; border-radius: 6px; font-weight: 600;
      font-size: 13px; cursor: pointer; transition: 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .btn-action {
      background: var(--accent); color: white; border: none; padding: 8px 14px; border-radius: 10px;
      font-weight: 700; cursor: pointer; font-size: 11px; display: inline-flex; align-items: center; gap: 6px;
    }
    /* Ä°konlar iÃ§in Ã¶zel sÄ±nÄ±f */
    .ico { font-style: normal; display: inline-flex; align-items: center; justify-content: center; width: 1.2em; }

    /* --- Google Kontrolleri DÃ¼zeltmesi --- */
    #auth_controls .btn-sync { background: #22c55e !important; }
    #auth_controls .btn-logout { background: #64748b !important; }
    
    .main-layout { display: grid; grid-template-columns: 650px 1fr; gap: 20px; width: 100%; max-width: 1750px; margin-bottom: 15px; }
    /* ... (CSS'in geri kalanÄ± orijinal dosyanla aynÄ±dÄ±r) ... */
  </style>
</head>
<body>

  <div class="app-header">
    <div class="header-left">
      <h1 style="font-size: 1.25rem; margin:0; font-weight: 900;">BÃ¼tÃ§e Planlama <span style="font-size:10px; opacity:0.5;">V5.2</span></h1>
      <div id="user_info" style="display:none; align-items:center; gap:8px; padding-left:12px; border-left: 1px solid var(--border);">
        <img id="user_img" src="" style="width:24px; height:24px; border-radius:50%; border: 1px solid var(--accent);">
        <span id="user_email" style="font-size:11px; font-weight:700; opacity: 0.8;"></span>
      </div>
    </div>
    <div class="header-right">
      <button id="auth_btn" class="google-btn" onclick="handleAuthClick()">
        <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" width="18"> Google ile BaÄŸlan
      </button>
      
      <div id="auth_controls" style="display:none; gap:10px;">
        <button id="btn_sync_manual" class="btn-action btn-sync" onclick="syncFromDrive()">
          <i class="ico">â˜ï¸</i> Yedekle
        </button>
        <button id="btn_logout" class="btn-action btn-logout" onclick="handleLogout()">
          <i class="ico">ğŸšª</i> Ã‡Ä±kÄ±ÅŸ
        </button>
      </div>
      
      <button onclick="toggleTheme()" class="btn-action" style="background: var(--header-bg); color: var(--text-main); border: 1px solid var(--border);">
        <i class="ico">ğŸŒ“</i>
      </button>
    </div>
  </div>

  <script nonce="umtdvr_v52">
    // ... Orijinal JS FonksiyonlarÄ±n ...
    // ... setAuthUi fonksiyonu iÃ§indeki ikonlarÄ±n kaybolmamasÄ± saÄŸlandÄ± ...

    function setAuthUi(isLoggedIn) {
      const authBtn = document.getElementById('auth_btn');
      const authControls = document.getElementById('auth_controls');
      const userInfo = document.getElementById('user_info');

      if (isLoggedIn) {
        authBtn.style.display = 'none';
        authControls.style.display = 'flex';
        userInfo.style.display = 'flex';
        // Ä°konlarÄ±n butondan silinmemesi iÃ§in innerHTML yerine element bazlÄ± kontrol saÄŸlandÄ±
      } else {
        authBtn.style.display = 'flex';
        authControls.style.display = 'none';
        userInfo.style.display = 'none';
      }
    }
<script nonce="umtdvr_v52">
    /* * BÃ¼tÃ§e Planlama UygulamasÄ± V5.2 - JS CORE (Part 1)
     */
    const CLIENT_ID = '874591165323-ktdp2ojebh4225v0335lvuk3pct8eraq.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/userinfo.email';
    const DATA_FILE_NAME = 'asil_v20_data.json';
    const NOTIFY_KEY = 'butce_notify_permission';

    let accessToken = null;
    let tokenClient = null;
    let driveFileId = null;
    let viewDate = new Date();
    let entries = [];
    let categories = [];
    let myCharts = { month: null, trend: null, cat: null };
    let syncTimeout = null;
    let lastActivity = Date.now();

    // --- GOOGLE DRIVE CORE ---
    function initTokenClient() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse.error !== undefined) throw tokenResponse;
          accessToken = tokenResponse.access_token;
          setAuthUi(true);
          fetchUserInfo();
          initializeDriveFile();
          toast('Google baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±', 'ok');
        },
      });
    }

    async function initializeDriveFile() {
      try {
        const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${DATA_FILE_NAME}' and parents in 'appDataFolder'&spaces=appDataFolder`, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        const data = await res.json();
        if (data.files && data.files.length > 0) {
          driveFileId = data.files[0].id;
          await syncFromDrive();
        } else {
          await createDriveFile();
        }
      } catch (e) { toast('Drive baÅŸlatÄ±lamadÄ±', 'err'); }
    }

    async function createDriveFile() {
      const metadata = { name: DATA_FILE_NAME, parents: ['appDataFolder'] };
      const res = await fetch('https://www.googleapis.com/drive/v3/files', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(metadata)
      });
      const file = await res.json();
      driveFileId = file.id;
      await syncToDrive();
    }

    async function syncToDrive() {
      if (!driveFileId || !accessToken) return;
      const allData = {};
      for (let i = 0; i < localStorage.length; i++) {
        let key = localStorage.key(i);
        if (key.startsWith('butce_') || key === 'butce_categories') {
          allData[key] = JSON.parse(localStorage.getItem(key));
        }
      }
      await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=media`, {
        method: 'PATCH',
        headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(allData)
      });
      console.log('Drive yedeklendi.');
    }

    async function syncFromDrive() {
      if (!driveFileId || !accessToken) return;
      const res = await fetch(`https://www.googleapis.com/drive/v3/files/${driveFileId}?alt=media`, {
        headers: { 'Authorization': `Bearer ${accessToken}` }
      });
      const driveData = await res.json();
      Object.keys(driveData).forEach(key => {
        localStorage.setItem(key, JSON.stringify(driveData[key]));
      });
      loadData();
      loadCategories();
      toast('Bulut verileri eÅŸitlendi', 'ok');
    }

    // --- VERÄ° YÃ–NETÄ°MÄ° ---
    function loadData() {
      const key = `butce_${viewDate.getFullYear()}_${viewDate.getMonth()}`;
      const stored = localStorage.getItem(key);
      entries = stored ? JSON.parse(stored) : [];
      renderAll();
    }

    function saveLocal() {
      const key = `butce_${viewDate.getFullYear()}_${viewDate.getMonth()}`;
      localStorage.setItem(key, JSON.stringify(entries));
      
      // Debounced Drive Sync
      clearTimeout(syncTimeout);
      syncTimeout = setTimeout(() => { if (accessToken) syncToDrive(); }, 3000);
    }

    function updateItem(idx, field, val) {
      if (field === 'amount' || field === 'billDay') val = parseFloat(val) || 0;
      entries[idx][field] = val;
      saveLocal();
      calculateStats();
      renderCalendar();
    }

    function calculateStats() {
      let inc = 0, inc_p = 0, exp = 0, exp_p = 0;
      entries.forEach(e => {
        const amt = parseFloat(e.amount) || 0;
        if (e.type === 'gelir') {
          if (e.status === 'paid') inc += amt; else inc_p += amt;
        } else {
          if (e.status === 'paid') exp += amt; else exp_p += amt;
        }
      });
      document.getElementById('t-inc').innerText = inc.toLocaleString() + ' TL';
      document.getElementById('t-incp').innerText = inc_p.toLocaleString() + ' TL';
      document.getElementById('t-exp').innerText = exp.toLocaleString() + ' TL';
      document.getElementById('t-pend').innerText = exp_p.toLocaleString() + ' TL';
      
      const net = (inc + inc_p) - (exp + exp_p);
      const netEl = document.getElementById('t-net');
      netEl.innerText = net.toLocaleString() + ' TL';
      netEl.parentElement.style.background = net < 0 ? 'var(--overdue)' : 'var(--accent)';
    }
	// --- GÃ–RÃœNÃœM (RENDER) ---
    function renderAll() {
      document.getElementById('display-month').innerText = `${aylar[viewDate.getMonth()]} ${viewDate.getFullYear()}`;
      const container = document.getElementById('entries-container');
      container.innerHTML = '';
      
      entries.forEach((e, idx) => {
        const row = document.createElement('div');
        row.className = 'entry-row';
        row.innerHTML = `
          <div class="icon-box">${getIcon(e.name)}</div>
          <input type="text" value="${e.name || ''}" placeholder="Ä°ÅŸlem" onchange="updateItem(${idx}, 'name', this.value)">
          <input type="number" value="${e.amount || ''}" placeholder="0" onchange="updateItem(${idx}, 'amount', this.value)">
          <select onchange="updateItem(${idx}, 'type', this.value); renderAll();">
            <option value="gider" ${e.type==='gider'?'selected':''}>Gider</option>
            <option value="gelir" ${e.type==='gelir'?'selected':''}>Gelir</option>
          </select>
          <input type="text" value="${e.category || 'Genel'}" placeholder="Kategori" onchange="updateItem(${idx}, 'category', this.value)">
          <input type="number" value="${e.billDay || 1}" min="1" max="31" onchange="updateItem(${idx}, 'billDay', this.value)">
          <div class="badge ${e.status==='paid'?'b-paid':'b-pending'}" onclick="toggleStatus(${idx})">
            ${e.status==='paid' ? (e.type==='gelir'?'ALINDI':'Ã–DENDÄ°') : 'BEKLE'}
          </div>
          <button onclick="removeRow(${idx})" style="border:none; background:none; cursor:pointer; color:var(--text-dim);">ğŸ—‘ï¸</button>
        `;
        container.appendChild(row);
      });
      calculateStats();
      renderCalendar();
    }

    function toggleStatus(idx) {
      entries[idx].status = entries[idx].status === 'paid' ? 'pending' : 'paid';
      saveLocal();
      renderAll();
    }

    function removeRow(idx) {
      if(confirm('Bu iÅŸlemi silmek istediÄŸinize emin misiniz?')) {
        entries.splice(idx, 1);
        saveLocal();
        renderAll();
      }
    }

    function getIcon(name) {
      const n = (name || "").toLowerCase();
      const map = { 'maaÅŸ':'ğŸ’°', 'kira':'ğŸ ', 'market':'ğŸ›’', 'fatura':'ğŸ“„', 'elektrik':'âš¡', 'su':'ğŸ’§', 'internet':'ğŸŒ', 'yakÄ±t':'â›½', 'kredi':'ğŸ’³', 'yemek':'ğŸ”' };
      for (let k in map) { if (n.includes(k)) return map[k]; }
      return 'ğŸ“';
    }

    // --- TAKVÄ°M ---
    function renderCalendar() {
      const body = document.getElementById('calendar-body');
      if(!body) return;
      body.innerHTML = '';
      const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
      
      for (let i = 1; i <= daysInMonth; i++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'cal-day';
        dayDiv.innerHTML = `<div style="font-size:10px; font-weight:900; margin-bottom:4px;">${i}</div>`;
        
        entries.filter(e => parseInt(e.billDay) === i).forEach(e => {
          const item = document.createElement('div');
          item.style = `font-size:8px; padding:2px 4px; border-radius:4px; margin-bottom:2px; background:${e.type==='gelir'?'#dcfce7':'#fee2e2'}; color:${e.type==='gelir'?'#166534':'#991b1b'};`;
          item.innerText = `${getIcon(e.name)} ${e.name}`;
          dayDiv.appendChild(item);
        });
        body.appendChild(dayDiv);
      }
    }

    // --- ANALÄ°Z & GRAFÄ°KLER ---
    function showAnalysis() {
      document.getElementById('chartModal').classList.remove('hidden');
      const ctx = document.getElementById('chart_month').getContext('2d');
      if (myCharts.month) myCharts.month.destroy();

      let exp = 0, pend = 0, inc = 0;
      entries.forEach(e => {
        const amt = parseFloat(e.amount) || 0;
        if(e.type === 'gider') {
          if(e.status === 'paid') exp += amt; else pend += amt;
        } else if(e.status === 'paid') inc += amt;
      });

      myCharts.month = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Ã–denen Gider', 'Bekleyen Gider', 'Net Kalan'],
          datasets: [{
            data: [exp, pend, Math.max(0, inc - exp - pend)],
            backgroundColor: ['#f43f5e', '#f59e0b', '#22c55e']
          }]
        },
        options: { plugins: { legend: { position: 'bottom' } } }
      });
    }

    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    // --- OLAY DÄ°NLEYÄ°CÄ°LERÄ° ---
    function bindEvents() {
      document.getElementById('btn_prev').onclick = () => { viewDate.setMonth(viewDate.getMonth() - 1); loadData(); };
      document.getElementById('btn_next').onclick = () => { viewDate.setMonth(viewDate.getMonth() + 1); loadData(); };
      document.getElementById('btn_add').onclick = () => { 
        entries.push({ name: '', amount: 0, type: 'gider', status: 'pending', billDay: new Date().getDate(), category: 'Genel' });
        renderAll();
      };
      document.getElementById('btn_chart').onclick = showAnalysis;
      document.getElementById('btn_pdf').onclick = () => {
        const element = document.querySelector('.budget-card');
        html2pdf().from(element).save(`Butce_${aylar[viewDate.getMonth()]}_${viewDate.getFullYear()}.pdf`);
      };
      
      // HÄ±zlÄ± Ä°ÅŸlem GiriÅŸi
      document.getElementById('quick_input').onkeypress = (e) => {
        if(e.key === 'Enter') {
          const val = e.target.value.split(' ');
          if(val.length >= 2) {
            entries.push({
              name: val[0],
              amount: parseFloat(val[1]) || 0,
              billDay: parseInt(val[2]) || new Date().getDate(),
              type: val[3] === 'gelir' ? 'gelir' : 'gider',
              status: 'pending'
            });
            e.target.value = '';
            saveLocal(); renderAll();
            toast('HÄ±zlÄ± iÅŸlem eklendi', 'ok');
          }
        }
      };
    }

    function toggleTheme() {
      const current = document.body.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', next);
      localStorage.setItem('butce_theme', next);
    }

    function handleLogout() {
      if(confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinize emin misiniz?')) {
        accessToken = null;
        setAuthUi(false);
        location.reload();
      }
    }

    function handleAuthClick() {
      if (tokenClient) tokenClient.requestAccessToken();
    }

    function toast(msg, type) {
      const t = document.createElement('div');
      t.className = 'toast show';
      t.style.background = type === 'err' ? '#ef4444' : '#10b981';
      t.innerText = msg;
      document.body.appendChild(t);
      setTimeout(() => { t.remove(); }, 3000);
    }

    // BaÅŸlat
    window.onload = () => {
      const savedTheme = localStorage.getItem('butce_theme');
      if(savedTheme) document.body.setAttribute('data-theme', savedTheme);
      initTokenClient();
      loadData();
      bindEvents();
    };
</script>
</body>
</html>
