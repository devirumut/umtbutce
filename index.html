<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BÃ¼tÃ§e Planlama UygulamasÄ± V5.2 (Single File)</title>

  <!-- Static nonce (single-file). For real deployments, generate per-request on server. -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'nonce-umtdvr_v52' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://accounts.google.com;
    style-src  'self' 'nonce-umtdvr_v52' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    img-src 'self' data: https://www.gstatic.com https://lh3.googleusercontent.com;
    connect-src 'self' https://www.googleapis.com https://oauth2.googleapis.com;
    frame-src https://www.altinkaynak.com;
    base-uri 'self';
    form-action 'self';
    object-src 'none';
    frame-ancestors 'none';
    upgrade-insecure-requests;
  " />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- External libs (allowed by CSP) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style nonce="umtdvr_v52">
    :root{
      --primary:#f8fafc; --card-bg:#ffffff; --accent:#4f46e5;
      --income:#22c55e; --expense:#f43f5e; --pending:#f59e0b; --overdue:#ef4444;
      --text-main:#1e293b; --text-dim:#64748b; --border:#e2e8f0; --header-bg:#f1f5f9;
      --shadow:0 10px 40px rgba(0,0,0,0.04);
    }
    [data-theme="dark"]{
      --primary:#0f172a; --card-bg:#1e293b; --accent:#818cf8;
      --text-main:#f1f5f9; --text-dim:#94a3b8; --border:#334155; --header-bg:#334155;
      --shadow:0 10px 40px rgba(0,0,0,0.25);
    }
    *{ box-sizing:border-box; }
    body{
      font-family:'Poppins',sans-serif; background:var(--primary); color:var(--text-main);
      margin:0; padding:10px; transition:.2s;
      display:flex; flex-direction:column; align-items:center; min-height:100vh;
    }

    .hidden{ display:none !important; }

    .app-header{
      width:100%; max-width:1750px; display:flex; justify-content:space-between; align-items:center;
      padding:10px 25px; background:var(--card-bg); border-radius:15px; margin-bottom:15px;
      box-shadow:0 4px 20px rgba(0,0,0,0.03); border:1px solid var(--border);
    }
    .header-left,.header-right{ display:flex; align-items:center; gap:12px; }
    .app-title{ font-size:1.25rem; margin:0; font-weight:900; }
    .app-ver{ font-size:10px; opacity:.5; font-weight:800; }

    .user-info{ display:flex; align-items:center; gap:8px; }
    .user-img{ width:24px; height:24px; border-radius:50%; }
    .user-email{ font-size:11px; font-weight:800; }

    .google-btn{
      display:flex; align-items:center; gap:10px; background:white; color:#3c4043;
      border:1px solid #dadce0; padding:8px 16px; border-radius:6px; font-weight:600;
      font-size:14px; cursor:pointer; transition:.2s; box-shadow:0 1px 3px rgba(0,0,0,.08);
      white-space:nowrap;
    }
    .google-btn:hover{ background:#f8f9fa; box-shadow:0 1px 3px 1px rgba(0,0,0,.15); }
    .google-btn img{ width:18px; height:18px; }

    .btn{
      background:var(--accent); color:#fff; border:none; padding:8px 12px; border-radius:10px;
      font-weight:700; cursor:pointer; font-size:11px; transition:.15s; white-space:nowrap;
      display:inline-flex; align-items:center; gap:6px;
    }
    .btn:active{ transform:translateY(1px); }
    .btn-tool{ background:var(--header-bg); color:var(--text-main); border:1px solid var(--border); }
    .btn-danger{ background:#ef4444 !important; }
    .btn-green{ background:#22c55e !important; }
    .btn-gray{ background:#64748b !important; }

    .chip{
      background:var(--header-bg); border:1px solid var(--border); color:var(--text-main);
      border-radius:999px; padding:6px 10px; font-size:11px; font-weight:700;
      display:inline-flex; align-items:center; gap:8px;
    }
    .chip-state{ opacity:.7; }

    .main-layout{
      width:100%; max-width:1750px; display:grid; grid-template-columns:650px 1fr; gap:20px;
      margin-bottom:15px;
    }
    .left-panel{ display:flex; flex-direction:column; gap:10px; }
    .widget-card{ background:var(--card-bg); border-radius:12px; border:1px solid var(--border); overflow:hidden; }
    .widget-header{ background:var(--header-bg); padding:6px 15px; font-size:.7rem; font-weight:800; color:var(--text-dim); text-transform:uppercase; }

    .crop-box{ height:42px; overflow:hidden; position:relative; background:#fff; }
    .currency-box{ height:78px; }
    .crop-box iframe{
      border:none; width:2400px; height:5000px; position:absolute;
      transform:scale(.63); transform-origin:0 0;
    }
    #frame-gram{ top:-260px; left:-25px; }
    #frame-ceyrek{ top:-182px; left:-775px; }
    #frame-doviz{ top:-184px; left:-25px; }

    .budget-card{
      background:var(--card-bg); padding:18px 22px; border-radius:20px; border:1px solid var(--border);
      box-shadow:var(--shadow);
    }
    .sticky-controls{
      position:sticky; top:0; background:var(--card-bg); z-index:50;
      padding-bottom:12px; border-bottom:1px solid var(--border); margin-bottom:12px;
    }

    .top-row{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .month-nav{ display:flex; align-items:center; gap:8px; }
    .display-month{ font-weight:900; min-width:160px; text-align:center; }

    .toolbar{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    }

    .control-bar{
      display:grid;
      grid-template-columns: 1.4fr .8fr .8fr .9fr .9fr;
      gap:8px;
      margin-top:10px;
    }

    input, select{
      background:var(--primary); border:1.5px solid var(--border); padding:8px 10px; border-radius:10px;
      font-size:12px; color:var(--text-main); outline:none;
    }
    input::placeholder{ color:var(--text-dim); }

    .quick-add{
      display:grid; grid-template-columns: 1fr 140px;
      gap:8px; margin-top:10px;
    }

    .muted{ color:var(--text-dim); font-size:11px; font-weight:700; margin-bottom:5px; }
    .muted-inline{ color:var(--text-dim); font-size:11px; font-weight:700; margin-top:8px; }

    .progress-wrap{ width:100%; background:#e2e8f0; height:8px; border-radius:4px; overflow:hidden; }
    .progress-fill{ height:100%; background:var(--accent); width:0%; transition:.4s; }

    .entry-head{
      display:grid; grid-template-columns: 34px 1.2fr .65fr .65fr .85fr .8fr .6fr .55fr 30px;
      gap:8px; align-items:center; padding:6px 4px 8px 4px; color:var(--text-dim); font-size:10px; font-weight:800;
      text-transform:uppercase;
    }
    .entry-row{
      display:grid; grid-template-columns: 34px 1.2fr .65fr .65fr .85fr .8fr .6fr .55fr 30px;
      gap:8px; align-items:center; margin-bottom:8px;
    }

    .icon-box{
  width:34px; height:32px; display:flex; align-items:center; justify-content:center;
  border:1px solid var(--border); border-radius:10px; background:var(--primary);
  font-size:16px; user-select:none;
}

    .badge{
      display:flex; align-items:center; justify-content:center; height:32px; border-radius:10px;
      cursor:pointer; font-size:9px; font-weight:900; border:1px solid var(--border); user-select:none;
      background:var(--primary);
    }
    .b-paid{ background:#dcfce7 !important; color:#166534 !important; border-color:#bbf7d0 !important; }
    .b-pending{ background:#fef3c7 !important; color:#92400e !important; border-color:#fde68a !important; }
    .b-overdue{ background:#fee2e2 !important; color:#991b1b !important; border-color:#fecaca !important; }
    .b-received{ background:#e0f2fe !important; color:#075985 !important; border-color:#bae6fd !important; }
    .b-await{ background:#f1f5f9 !important; color:#475569 !important; }

    .delx{ border:none; background:none; color:var(--text-dim); cursor:pointer; font-size:18px; line-height:1; }

    .btn-add-row{
      width:100%; margin-top:10px; background:none; border:1px dashed var(--accent); color:var(--accent);
      justify-content:center;
    }

    .summary-grid{ display:grid; grid-template-columns:repeat(5,1fr); gap:10px; margin-top:14px; }
    .stat{
      padding:12px; border-radius:14px; background:var(--primary); border:1px solid var(--border);
    }
    .stat small{ display:block; font-weight:800; color:var(--text-dim); }
    .stat .val{ font-weight:900; margin-top:4px; }
    .stat.net{ background:var(--accent); color:#fff; border-color:transparent; }
    .stat.net small{ color:rgba(255,255,255,.8); }
    .val-inc{ color:var(--income); }
    .val-incp{ color:#38bdf8; }
    .val-exp{ color:var(--expense); }
    .val-pend{ color:var(--pending); }

    .calendar-section{
      width:100%; max-width:1750px; background:var(--card-bg); padding:15px 25px; border-radius:20px;
      border:1px solid var(--border); box-shadow:0 4px 20px rgba(0,0,0,0.03);
    }
    .calendar-title{ font-weight:900; font-size:.95rem; }
    .calendar-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:10px; }
    .cal-day{ background:var(--primary); border:1px solid var(--border); min-height:70px; border-radius:12px; padding:6px; }
    .day-num{ font-size:10px; font-weight:900; }
    .pill{
      font-size:8px; padding:3px 4px; border-radius:6px; margin-top:4px; border:1px solid rgba(0,0,0,0.04);
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }

    .modal-overlay{
      position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%;
      background:rgba(0,0,0,0.6); backdrop-filter: blur(5px);
      justify-content:center; align-items:center;
      display:flex;
    }
    .modal{
      background:var(--card-bg); padding:22px; border-radius:20px; border:1px solid var(--border);
      width:92%; max-width:860px; max-height:86vh; overflow:auto; position:relative; box-shadow:var(--shadow);
    }
    .closex{
      position:absolute; top:14px; right:14px; font-size:24px; cursor:pointer; color:var(--text-dim);
      border:none; background:none;
    }

    .toast{
      position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(120px);
      padding:12px 18px; border-radius:14px; color:#fff; font-weight:700; font-size:13px;
      z-index:9999; transition:.35s; display:flex; gap:10px; align-items:center;
      box-shadow:0 12px 30px rgba(0,0,0,0.25);
    }
    .toast.show{ transform:translateX(-50%) translateY(0); }
    .t-info{ background:#4f46e5; } .t-ok{ background:#10b981; } .t-err{ background:#ef4444; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .tab{ padding:8px 10px; border-radius:999px; border:1px solid var(--border); background:var(--header-bg);
      font-size:11px; font-weight:900; cursor:pointer; }
    .tab.active{ background:var(--accent); color:#fff; border-color:transparent; }
    .tabpane{ display:none; margin-top:10px; }
    .tabpane.active{ display:block; }
    .chart-wrap{ width:100%; max-width:520px; margin:0 auto; height:280px; }
    .chart-tall{ height:300px; }
    canvas{ max-width:100%; }

    .settings-top{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .hr{ border:none; border-top:1px solid var(--border); margin:14px 0; }

    .section-label{ font-size:11px; font-weight:900; color:var(--text-dim); margin-bottom:8px; }
    .cat-add{ display:flex; gap:8px; margin-bottom:10px; }
    .cat-list{ display:flex; flex-wrap:wrap; gap:8px; }

    .critical{
      background:#fff1f2; border:1px solid #fecaca; padding:12px; border-radius:14px;
    }
    .critical-title{ color:#991b1b; font-size:11px; font-weight:900; }
    .critical-desc{ color:#b91c1c; font-size:10px; font-weight:700; margin-top:4px; }
    .critical-btn{ width:100%; margin-top:10px; }

    .footer{ margin:18px 0 10px; font-size:10px; color:var(--text-dim); opacity:.65; }
  </style>
</head>

<body>
  <div class="app-header">
    <div class="header-left">
      <h1 class="app-title">BÃ¼tÃ§e Planlama <span class="app-ver">V5.2</span></h1>
      <div id="user-info" class="user-info hidden">
        <img id="user-img" alt="user" src="" class="user-img">
        <span id="user-email" class="user-email"></span>
      </div>
    </div>

    <div class="header-right">
      <button id="auth_btn" class="google-btn" type="button">
        <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" alt="Google"> Google ile BaÄŸlan
      </button>

      <div id="auth_controls" class="auth-controls hidden">
        <span id="session_badge" class="chip hidden">
          <span id="session_countdown">15:00</span>
          <span id="session_state" class="chip-state">ACTIVE</span>
        </span>
        <button id="btn_backup" class="btn btn-green" type="button">Yedekle</button>
        <button id="btn_logout" class="btn btn-gray" type="button">Ã‡Ä±kÄ±ÅŸ</button>
      </div>

      <button id="btn_theme" type="button" class="btn btn-tool">Tema</button>
    </div>
  </div>

  <div class="main-layout">
    <div class="left-panel">
      <div class="widget-card">
        <div class="widget-header">24 AYAR GRAM</div>
        <div class="crop-box">
          <iframe src="https://www.altinkaynak.com/canli-kurlar/altin"
                  id="frame-gram"
                  loading="lazy"
                  referrerpolicy="no-referrer"
                  sandbox="allow-scripts allow-same-origin"></iframe>
        </div>
      </div>

      <div class="widget-card">
        <div class="widget-header">Ã‡EYREK ALTIN</div>
        <div class="crop-box">
          <iframe src="https://www.altinkaynak.com/canli-kurlar/altin"
                  id="frame-ceyrek"
                  loading="lazy"
                  referrerpolicy="no-referrer"
                  sandbox="allow-scripts allow-same-origin"></iframe>
        </div>
      </div>

      <div class="widget-card">
        <div class="widget-header">DOLAR & EURO</div>
        <div class="crop-box currency-box">
          <iframe src="https://www.altinkaynak.com/canli-kurlar/doviz"
                  id="frame-doviz"
                  loading="lazy"
                  referrerpolicy="no-referrer"
                  sandbox="allow-scripts allow-same-origin"></iframe>
        </div>
      </div>
    </div>

    <div class="budget-card">
      <div class="sticky-controls">
        <div class="top-row">
          <div class="month-nav">
            <button id="btn_prev" type="button" class="btn">Geri</button>
            <span id="display-month" class="display-month"></span>
            <button id="btn_next" type="button" class="btn">Ä°leri</button>
          </div>

          <div class="toolbar">
            <button id="btn_search" type="button" class="btn btn-tool" title="Ara / Filtre">Ara</button>
            <button id="btn_yearly" type="button" class="btn btn-tool">YÄ±llÄ±k</button>
            <button id="btn_chart" type="button" class="btn btn-tool">Analiz</button>
            <button id="btn_pdf" type="button" class="btn btn-tool">PDF</button>
            <button id="btn_settings" type="button" class="btn btn-tool">Ayarlar</button>
          </div>
        </div>

        <div class="muted" id="progress-text">HARCAMA ORANI: %0</div>
        <div class="progress-wrap"><div id="progress-fill" class="progress-fill"></div></div>

        <div class="quick-add">
          <input id="quick_input" placeholder="HÄ±zlÄ± ekle: Ã¶rn 'kira 8500 5 gider' / 'maaÅŸ 45000 1 gelir'">
          <button id="btn_quick_add" class="btn" type="button">HÄ±zlÄ± Ekle</button>
        </div>

        <div id="search_panel" class="control-bar hidden">
          <input id="f_search" placeholder="Ara (isim/etiket)">
          <select id="f_type">
            <option value="all">TÃ¼r: Hepsi</option>
            <option value="gelir">TÃ¼r: Gelir</option>
            <option value="gider">TÃ¼r: Gider</option>
          </select>
          <select id="f_status">
            <option value="all">Durum: Hepsi</option>
            <option value="paid">Durum: Ã–dendi/AlÄ±ndÄ±</option>
            <option value="pending">Durum: Bekliyor</option>
            <option value="overdue">Durum: Gecikti</option>
          </select>
          <select id="f_cat">
            <option value="all">Kategori: Hepsi</option>
          </select>
          <select id="f_sort">
            <option value="day_asc">SÄ±rala: GÃ¼n â†‘</option>
            <option value="day_desc">SÄ±rala: GÃ¼n â†“</option>
            <option value="amt_desc">SÄ±rala: Tutar â†“</option>
            <option value="amt_asc">SÄ±rala: Tutar â†‘</option>
            <option value="name_asc">SÄ±rala: Ä°sim A-Z</option>
          </select>
        </div>
      </div>

      <div class="entry-head">
        <div></div><div>Ä°ÅŸlem</div><div>Tutar</div><div>TÃ¼r</div><div>Kategori</div><div>GÃ¼n</div><div>Tekrar</div><div>Durum</div><div></div>
      </div>
      <div id="entries-container"></div>

      <button id="btn_add" type="button" class="btn btn-add-row">Yeni Ä°ÅŸlem</button>

      <div class="summary-grid">
        <div class="stat"><small>GELÄ°R (ALINAN)</small><div class="val val-inc" id="t-inc">0 TL</div></div>
        <div class="stat"><small>GELÄ°R (BEKLEYEN)</small><div class="val val-incp" id="t-incp">0 TL</div></div>
        <div class="stat"><small>GÄ°DER (Ã–DENEN)</small><div class="val val-exp" id="t-exp">0 TL</div></div>
        <div class="stat"><small>GÄ°DER (BEKLEYEN)</small><div class="val val-pend" id="t-pend">0 TL</div></div>
        <div class="stat net"><small>NET (TAHMÄ°NÄ°)</small><div class="val" id="t-net">0 TL</div></div>
      </div>
    </div>
  </div>

  <div class="calendar-section">
    <div class="calendar-title">Ã–deme Takvimi</div>
    <div class="calendar-grid" id="calendar-body"></div>
  </div>

  <div class="footer">umtdvr</div>

  <!-- ANALIZ MODAL -->
  <div id="chartModal" class="modal-overlay hidden">
    <div class="modal">
      <button class="closex" type="button" data-close="chartModal">Ã—</button>
      <h3 style="margin:0 0 6px 0;">Analiz</h3>

      <div class="tabs">
        <div class="tab active" data-tab="tab-month">AylÄ±k DaÄŸÄ±lÄ±m</div>
        <div class="tab" data-tab="tab-trend">Trend (12 Ay)</div>
        <div class="tab" data-tab="tab-cats">Kategori</div>
      </div>

      <div class="tabpane active" id="tab-month">
        <div class="chart-wrap"><canvas id="chart_month"></canvas></div>
        <div class="muted-inline">Net negatifse grafikte 0 gÃ¶sterilir.</div>
      </div>

      <div class="tabpane" id="tab-trend">
        <div class="chart-wrap chart-tall"><canvas id="chart_trend"></canvas></div>
        <div class="muted-inline">GerÃ§ekleÅŸen: paid. Tahmin: paid + pending.</div>
      </div>

      <div class="tabpane" id="tab-cats">
        <div class="chart-wrap"><canvas id="chart_cat"></canvas></div>
        <div class="muted-inline">Sadece giderler kategori bazlÄ± gÃ¶sterilir (paid + pending).</div>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div id="settingsModal" class="modal-overlay hidden">
    <div class="modal">
      <button class="closex" type="button" data-close="settingsModal">Ã—</button>
      <h3 style="margin:0 0 10px 0;">Ayarlar</h3>

      <div class="settings-top">
        <button id="btn_undo" class="btn btn-tool" type="button">Geri Al</button>
        <button id="btn_notify" class="btn btn-tool" type="button">Bildirim Ä°zni</button>
        <button id="btn_sync" class="btn btn-tool" type="button">Buluttan Ã‡ek</button>
      </div>

      <hr class="hr">

      <div class="section-label">KATEGORÄ°LER</div>
      <div class="cat-add">
        <input id="cat_input" placeholder="Yeni kategori adÄ±">
        <button id="btn_add_cat" class="btn" type="button">Ekle</button>
      </div>
      <div id="cat_list" class="cat-list"></div>

      <hr class="hr">

      <div class="critical">
        <div class="critical-title">KRÄ°TÄ°K</div>
        <div class="critical-desc">Yerel verileri sÄ±fÄ±rlar. Bulut yedeÄŸi varsa geri alÄ±nabilir.</div>
        <button id="btn_reset" class="btn btn-danger critical-btn" type="button">Yerel Verileri SÄ±fÄ±rla</button>
      </div>
    </div>
  </div>

  <!-- YEARLY MODAL -->
  <div id="yearlyModal" class="modal-overlay hidden">
    <div class="modal">
      <button class="closex" type="button" data-close="yearlyModal">Ã—</button>
      <h3 id="yearly-title" style="margin:0 0 10px 0;">YÄ±llÄ±k Ã–zet</h3>
      <div id="yearly-content"></div>
    </div>
  </div>

  <script nonce="umtdvr_v52">
    (() => {
      'use strict';

      const CLIENT_ID = '874591165323-ktdp2ojebh4225v0335lvuk3pct8eraq.apps.googleusercontent.com';
      const SCOPES = [
        'https://www.googleapis.com/auth/drive.appdata',
        'https://www.googleapis.com/auth/userinfo.email',
        'https://www.googleapis.com/auth/userinfo.profile'
      ].join(' ');

      const DRIVE_BACKUP_NAME = 'budget_appdata_v2.json';
      const STORAGE_PREFIX = 'butce_';
      const THEME_KEY = 'budget_theme_v1';
      const CAT_KEY = 'budget_categories_v1';
      const NOTIFY_KEY = 'budget_notify_enabled_v1';

      const SESSION_TIMEOUT_MS = 15 * 60 * 1000;
      const MOUSE_RESET_THROTTLE_MS = 5000;

      const aylar = ["OCAK","ÅžUBAT","MART","NÄ°SAN","MAYIS","HAZÄ°RAN","TEMMUZ","AÄžUSTOS","EYLÃœL","EKÄ°M","KASIM","ARALIK"];

      let accessToken = null;
      let tokenClient = null;
      let driveFileId = null;

      let viewDate = new Date();
      let entries = [];
      let categories = [];
      let undoStack = [];

      let sessionTimer = null;
      let countdownTimer = null;
      let sessionActive = false;
      let sessionExpireAt = 0;
      let lastMouseResetAt = 0;

      let autoBackupTimer = null;
      const AUTO_BACKUP_DEBOUNCE_MS = 30000;

      const iconMap = [
  { k:'maaÅŸ', v:'ðŸ’°' }, { k:'kira', v:'ðŸ ' }, { k:'market', v:'ðŸ›’' }, { k:'fatura', v:'ðŸ“„' },
  { k:'elektrik', v:'âš¡' }, { k:'su', v:'ðŸ’§' }, { k:'doÄŸalgaz', v:'ðŸ”¥' }, { k:'internet', v:'ðŸŒ' },
  { k:'telefon', v:'ðŸ“±' }, { k:'akaryakÄ±t', v:'â›½' }, { k:'araba', v:'ðŸš—' }, { k:'altÄ±n', v:'ðŸª™' },
  { k:'kredi', v:'ðŸ’³' }, { k:'yemek', v:'ðŸ”' }
];

function getIcon(name) {
  const n = String(name || '').toLowerCase();
  for (const it of iconMap) if (n.includes(it.k)) return it.v;
  return 'ðŸ‘›';
}

      const $ = (id) => document.getElementById(id);

      function toast(message, type='info') {
        const t = document.createElement('div');
        t.className = `toast ${type==='ok'?'t-ok':type==='err'?'t-err':'t-info'}`;
        t.textContent = String(message || '');
        document.body.appendChild(t);
        setTimeout(()=>t.classList.add('show'), 50);
        setTimeout(()=>{
          t.classList.remove('show');
          setTimeout(()=>t.remove(), 300);
        }, 2600);
      }

      function showModal(id){ $(id).classList.remove('hidden'); }
      function closeModal(id){ $(id).classList.add('hidden'); }

      function safeJsonParse(raw, fallback) {
        try { return JSON.parse(raw); } catch { return fallback; }
      }
      function safeSetItem(key, value) {
        try { localStorage.setItem(key, value); return true; } catch { toast('Depolama hatasÄ±', 'err'); return false; }
      }

      function applyTheme(theme) {
        document.body.setAttribute('data-theme', theme === 'dark' ? 'dark' : 'light');
      }
      function loadTheme() {
        const t = localStorage.getItem(THEME_KEY);
        applyTheme(t === 'dark' ? 'dark' : 'light');
      }
      function toggleTheme() {
        const cur = document.body.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        const next = cur === 'dark' ? 'light' : 'dark';
        applyTheme(next);
        safeSetItem(THEME_KEY, next);
      }

      function daysInMonth(year, monthIndex0){ return new Date(year, monthIndex0 + 1, 0).getDate(); }
      function storageKeyFor(dateObj){ return `${STORAGE_PREFIX}${aylar[dateObj.getMonth()]}_${dateObj.getFullYear()}`; }

      function parseMoney(raw) {
        const s = String(raw ?? '').trim().replace(',', '.');
        const n = Number(s);
        if (!Number.isFinite(n) || n < 0) return { ok:false, value:0 };
        return { ok:true, value: Math.round(n * 100) / 100 };
      }

      function normalizeBillDay(raw, year, monthIndex0) {
        const d = Number.parseInt(String(raw ?? ''), 10);
        const max = daysInMonth(year, monthIndex0);
        if (!Number.isFinite(d)) return 1;
        return Math.min(Math.max(d, 1), max);
      }

      function normalizeEntry(e0, year, monthIndex0) {
        const e = e0 && typeof e0 === 'object' ? e0 : {};
        const type = e.type === 'gelir' ? 'gelir' : 'gider';
        const status = (e.status === 'paid' || e.status === 'overdue') ? e.status : 'pending';
        const repeat = (e.repeat === 'monthly') ? 'monthly' : 'none';
        const cat = String(e.category ?? '').trim();
        const amt = parseMoney(e.amount);
        return {
          id: String(e.id ?? cryptoRandomId()),
          name: String(e.name ?? '').slice(0, 80),
          amount: amt.value,
          type,
          category: cat || (type === 'gelir' ? 'Gelir' : 'Genel'),
          billDay: normalizeBillDay(e.billDay, year, monthIndex0),
          repeat,
          status,
          tags: String(e.tags ?? '').slice(0, 60)
        };
      }

      function cryptoRandomId() {
        try {
          const a = new Uint8Array(8);
          crypto.getRandomValues(a);
          return Array.from(a).map(x=>x.toString(16).padStart(2,'0')).join('');
        } catch {
          return Math.random().toString(16).slice(2) + Date.now().toString(16);
        }
      }

      function loadCategories() {
        const raw = localStorage.getItem(CAT_KEY);
        const arr = safeJsonParse(raw, null);
        categories = Array.isArray(arr) ? arr.filter(x=>typeof x==='string' && x.trim()).map(x=>x.trim()) : [];
        if (categories.length === 0) categories = ['Genel','Kira','Fatura','Market','UlaÅŸÄ±m','Yemek','EÄŸlence','SaÄŸlÄ±k','EÄŸitim','AltÄ±n','Kredi','Gelir'];
        saveCategories();
      }
      function saveCategories() { safeSetItem(CAT_KEY, JSON.stringify(Array.from(new Set(categories)))); }

      function loadData() {
        const key = storageKeyFor(viewDate);
        const stored = localStorage.getItem(key);
        const parsed = safeJsonParse(stored, []);
        const y = viewDate.getFullYear();
        const m = viewDate.getMonth();

        entries = Array.isArray(parsed) ? parsed.map(e => normalizeEntry(e, y, m)) : [];

        if (entries.length === 0) {
          entries = [normalizeEntry({ name:'', amount:0, type:'gider', status:'pending', billDay:1, category:'Genel', repeat:'none' }, y, m)];
          saveData();
        }

        seedRecurringFromPreviousMonth();
        markOverdueForViewedMonth();
        renderAll();
      }

      function saveData() {
        const key = storageKeyFor(viewDate);
        const y = viewDate.getFullYear();
        const m = viewDate.getMonth();
        const norm = entries.map(e => {
          const n = normalizeEntry(e, y, m);
          return { id:n.id, name:n.name, amount:n.amount, type:n.type, category:n.category, billDay:n.billDay, repeat:n.repeat, status:n.status, tags:n.tags };
        });
        safeSetItem(key, JSON.stringify(norm));
        scheduleAutoBackup();
      }

      function scheduleAutoBackup() {
        if (!accessToken || !driveFileId) return;
        if (autoBackupTimer) clearTimeout(autoBackupTimer);
        autoBackupTimer = setTimeout(async () => { try { await syncToDrive(true); } catch {} }, AUTO_BACKUP_DEBOUNCE_MS);
      }

      function safeLoadMonth(year, monthIndex0) {
        const key = `${STORAGE_PREFIX}${aylar[monthIndex0]}_${year}`;
        const raw = localStorage.getItem(key);
        const parsed = safeJsonParse(raw, []);
        return Array.isArray(parsed) ? parsed : [];
      }

      function seedRecurringFromPreviousMonth() {
        const y = viewDate.getFullYear();
        const m = viewDate.getMonth();
        const prev = new Date(y, m - 1, 1);
        const py = prev.getFullYear();
        const pm = prev.getMonth();

        const prevData = safeLoadMonth(py, pm).map(e => normalizeEntry(e, py, pm));
        const recurring = prevData.filter(e => e.repeat === 'monthly');
        if (recurring.length === 0) return;

        const idsThisMonth = new Set(entries.map(e => e.id));
        let added = 0;

        for (const r of recurring) {
          if (idsThisMonth.has(r.id)) continue;
          const clone = normalizeEntry({ ...r, status:'pending' }, y, m);
          clone.id = r.id;
          const exists = entries.some(e => (e.name||'').toLowerCase() === (clone.name||'').toLowerCase() && e.type===clone.type && e.billDay===clone.billDay);
          if (exists) continue;
          entries.push(clone);
          added++;
        }
        if (added > 0) saveData();
      }

      function markOverdueForViewedMonth() {
        const now = new Date();
        const sameMonth = now.getFullYear() === viewDate.getFullYear() && now.getMonth() === viewDate.getMonth();
        if (!sameMonth) return;

        const today = now.getDate();
        let changed = false;

        for (const e of entries) {
          if (e.type === 'gider' && e.status === 'pending' && e.billDay < today) { e.status = 'overdue'; changed = true; }
          if (e.type === 'gider' && e.status === 'overdue' && e.billDay >= today) { e.status = 'pending'; changed = true; }
        }
        if (changed) saveData();
      }

      function getFilters() {
        return {
          search: ($('f_search').value || '').trim().toLowerCase(),
          type: $('f_type').value,
          status: $('f_status').value,
          cat: $('f_cat').value,
          sort: $('f_sort').value
        };
      }

      function applyFilterSort(list) {
        const f = getFilters();
        let out = list.slice();

        if (f.search) out = out.filter(e => (e.name||'').toLowerCase().includes(f.search) || (e.tags||'').toLowerCase().includes(f.search));
        if (f.type !== 'all') out = out.filter(e => e.type === f.type);
        if (f.status !== 'all') out = out.filter(e => e.status === f.status);
        if (f.cat !== 'all') out = out.filter(e => e.category === f.cat);

        const byName = (a,b)=> (a.name||'').localeCompare((b.name||''), 'tr');
        const byDay = (a,b)=> (a.billDay||0) - (b.billDay||0);
        const byAmt = (a,b)=> (a.amount||0) - (b.amount||0);

        if (f.sort === 'day_asc') out.sort(byDay);
        if (f.sort === 'day_desc') out.sort((a,b)=>byDay(b,a));
        if (f.sort === 'amt_asc') out.sort(byAmt);
        if (f.sort === 'amt_desc') out.sort((a,b)=>byAmt(b,a));
        if (f.sort === 'name_asc') out.sort(byName);

        return out;
      }

      function calculateMonth(list, year, monthIndex0) {
        let incPaid=0, incPending=0, expPaid=0, expPending=0, expOver=0;
        for (const e0 of list) {
          const e = normalizeEntry(e0, year, monthIndex0);
          if (e.type === 'gelir') {
            if (e.status === 'paid') incPaid += e.amount;
            else incPending += e.amount;
          } else {
            if (e.status === 'paid') expPaid += e.amount;
            else if (e.status === 'overdue') expOver += e.amount;
            else expPending += e.amount;
          }
        }
        const incForecast = incPaid + incPending;
        const outForecast = expPaid + expPending + expOver;
        const netForecast = incForecast - outForecast;
        const ratio = incForecast > 0 ? Math.min((outForecast / incForecast) * 100, 100) : 0;
        return { incPaid, incPending, expPaid, expPending, expOver, netForecast, ratio };
      }

      function setAuthUi(isAuthed) {
        $('auth_btn').classList.toggle('hidden', isAuthed);
        $('auth_controls').classList.toggle('hidden', !isAuthed);
      }

      function renderMonthTitle() {
        $('display-month').textContent = `${aylar[viewDate.getMonth()]} ${viewDate.getFullYear()}`;
      }

      function renderFilters() {
        const sel = $('f_cat');
        const cur = sel.value;

        while (sel.firstChild) sel.removeChild(sel.firstChild);
        const optAll = document.createElement('option');
        optAll.value = 'all';
        optAll.textContent = 'Kategori: Hepsi';
        sel.appendChild(optAll);

        for (const c of categories) {
          const o = document.createElement('option');
          o.value = c;
          o.textContent = c;
          sel.appendChild(o);
        }

        sel.value = categories.includes(cur) ? cur : 'all';
      }

      function renderCategoryChips() {
        const host = $('cat_list');
        host.textContent = '';
        for (const c of categories) {
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.textContent = c;

          const x = document.createElement('button');
          x.textContent = 'Ã—';
          x.type = 'button';
          x.style.border='none'; x.style.background='none'; x.style.cursor='pointer';
          x.style.fontWeight='900'; x.style.color='var(--text-dim)';

          x.addEventListener('click', () => {
            if (c === 'Gelir' || c === 'Genel') return;
            categories = categories.filter(z => z !== c);
            saveCategories();
            let changed = false;
            for (const e of entries) if (e.category === c) { e.category = 'Genel'; changed = true; }
            if (changed) saveData();
            renderFilters();
            renderCategoryChips();
            renderAll();
          });

          chip.appendChild(x);
          host.appendChild(chip);
        }
      }

      function renderSummary() {
        const y = viewDate.getFullYear();
        const m = viewDate.getMonth();
        const s = calculateMonth(entries, y, m);

        $('t-inc').textContent = `${s.incPaid.toLocaleString()} TL`;
        $('t-incp').textContent = `${s.incPending.toLocaleString()} TL`;
        $('t-exp').textContent = `${s.expPaid.toLocaleString()} TL`;
        $('t-pend').textContent = `${(s.expPending + s.expOver).toLocaleString()} TL`;
        $('t-net').textContent = `${s.netForecast.toLocaleString()} TL`;

        $('progress-fill').style.width = `${s.ratio}%`;
        $('progress-text').textContent = `HARCAMA ORANI: %${s.ratio.toFixed(1)}  â€¢  GECÄ°KEN: ${s.expOver.toLocaleString()} TL`;

        return s;
      }

      function badgeClass(e) {
        if (e.type === 'gelir') return e.status === 'paid' ? 'b-received' : 'b-await';
        if (e.status === 'paid') return 'b-paid';
        if (e.status === 'overdue') return 'b-overdue';
        return 'b-pending';
      }
      function badgeText(e) {
        if (e.type === 'gelir') return e.status === 'paid' ? 'ALINDI' : 'BEKLE';
        if (e.status === 'paid') return 'Ã–DENDÄ°';
        if (e.status === 'overdue') return 'GECÄ°KTÄ°';
        return 'BEKLE';
      }

      function renderRows() {
        const host = $('entries-container');
        host.textContent = '';

        const y = viewDate.getFullYear();
        const m = viewDate.getMonth();
        const viewList = applyFilterSort(entries);

        viewList.forEach((item) => {
          const idx = entries.findIndex(e => e.id === item.id);
          if (idx < 0) return;

          const e = normalizeEntry(entries[idx], y, m);
          entries[idx] = e;

          const row = document.createElement('div');
          row.className = 'entry-row';

          const icon = document.createElement('div');
          icon.className = 'icon-box';
          icon.textContent = getIcon(e.name);

          const inName = document.createElement('input');
          inName.value = e.name;
          inName.placeholder = 'Ä°ÅŸlem';
          inName.addEventListener('input', (ev) => {
            entries[idx].name = String(ev.target.value).slice(0,80);
            icon.textContent = getIcon(entries[idx].name);
            saveData();
            renderCalendar();
          });

          const inAmount = document.createElement('input');
          inAmount.type = 'number';
          inAmount.placeholder = '0';
          inAmount.value = e.amount ? String(e.amount) : '';
          inAmount.addEventListener('input', (ev) => {
            const amt = parseMoney(ev.target.value);
            entries[idx].amount = amt.value;
            saveData();
            renderSummary();
          });

          const selType = document.createElement('select');
          {
            const o1 = document.createElement('option'); o1.value='gelir'; o1.textContent='Gelir';
            const o2 = document.createElement('option'); o2.value='gider'; o2.textContent='Gider';
            selType.appendChild(o1); selType.appendChild(o2);
          }
          selType.value = e.type;
          selType.addEventListener('change', (ev) => {
            const before = { ...entries[idx] };
            entries[idx].type = ev.target.value === 'gelir' ? 'gelir' : 'gider';
            if (!categories.includes(entries[idx].category)) entries[idx].category = entries[idx].type === 'gelir' ? 'Gelir' : 'Genel';
            undoPush({ type:'update', payload:{ id:e.id, before, after:{...entries[idx]} }});
            saveData();
            renderAll();
          });

          const selCat = document.createElement('select');
          for (const c of categories) {
            const o = document.createElement('option');
            o.value = c;
            o.textContent = c;
            selCat.appendChild(o);
          }
          selCat.value = categories.includes(e.category) ? e.category : (e.type==='gelir'?'Gelir':'Genel');
          selCat.addEventListener('change', (ev) => {
            const before = { ...entries[idx] };
            entries[idx].category = ev.target.value;
            undoPush({ type:'update', payload:{ id:e.id, before, after:{...entries[idx]} }});
            saveData();
            renderAll();
          });

          const inDay = document.createElement('input');
          inDay.type = 'number';
          inDay.min = '1';
          inDay.max = String(daysInMonth(y,m));
          inDay.value = String(e.billDay || 1);
          inDay.addEventListener('input', (ev) => {
            const before = { ...entries[idx] };
            entries[idx].billDay = normalizeBillDay(ev.target.value, y, m);
            undoPush({ type:'update', payload:{ id:e.id, before, after:{...entries[idx]} }});
            saveData();
            renderCalendar();
            markOverdueForViewedMonth();
            renderRows();
          });

          const selRepeat = document.createElement('select');
          {
            const o1 = document.createElement('option'); o1.value='none'; o1.textContent='Tekrar: Yok';
            const o2 = document.createElement('option'); o2.value='monthly'; o2.textContent='Tekrar: AylÄ±k';
            selRepeat.appendChild(o1); selRepeat.appendChild(o2);
          }
          selRepeat.value = e.repeat;
          selRepeat.addEventListener('change', (ev) => {
            const before = { ...entries[idx] };
            entries[idx].repeat = ev.target.value === 'monthly' ? 'monthly' : 'none';
            undoPush({ type:'update', payload:{ id:e.id, before, after:{...entries[idx]} }});
            saveData();
          });

          const badge = document.createElement('div');
          badge.className = `badge ${badgeClass(e)}`;
          badge.textContent = badgeText(e);
          badge.addEventListener('click', () => {
            const before = { ...entries[idx] };
            entries[idx].status = entries[idx].status === 'paid' ? 'pending' : 'paid';
            undoPush({ type:'update', payload:{ id:e.id, before, after:{...entries[idx]} }});
            saveData();
            markOverdueForViewedMonth();
            renderAll();
          });

          const del = document.createElement('button');
          del.className = 'delx';
          del.type = 'button';
          del.textContent = 'Ã—';
          del.addEventListener('click', () => {
            const removed = entries[idx];
            undoPush({ type:'delete', payload:{ index: idx, entry: removed }});
            entries.splice(idx, 1);
            if (entries.length === 0) entries = [normalizeEntry({ name:'', amount:0, type:'gider', status:'pending', billDay:1, category:'Genel' }, y, m)];
            saveData();
            renderAll();
            toast('Ä°ÅŸlem silindi', 'info');
          });

          row.appendChild(icon);
          row.appendChild(inName);
          row.appendChild(inAmount);
          row.appendChild(selType);
          row.appendChild(selCat);
          row.appendChild(inDay);
          row.appendChild(selRepeat);
          row.appendChild(badge);
          row.appendChild(del);

          host.appendChild(row);
        });
      }

      function renderCalendar() {
        const body = $('calendar-body');
        body.textContent = '';
        const year = viewDate.getFullYear();
        const month = viewDate.getMonth();
        const days = daysInMonth(year, month);

        for (let d=1; d<=days; d++) {
          const day = document.createElement('div');
          day.className = 'cal-day';

          const num = document.createElement('div');
          num.className = 'day-num';
          num.textContent = String(d);
          day.appendChild(num);

          const todays = entries.filter(e => normalizeBillDay(e.billDay, year, month) === d);
          for (const ev0 of todays) {
            const ev = normalizeEntry(ev0, year, month);
            const p = document.createElement('div');
            p.className = 'pill';
            if (ev.type === 'gelir') p.style.background = ev.status === 'paid' ? '#e0f2fe' : '#f1f5f9';
            else p.style.background = ev.status === 'paid' ? '#dcfce7' : (ev.status === 'overdue' ? '#fee2e2' : '#fef3c7');
            p.textContent = `${getIcon(ev.name)} ${ev.name || 'Ä°simsiz'} â€¢ ${ev.amount.toLocaleString()} TL`;
            day.appendChild(p);
          }

          body.appendChild(day);
        }
      }

      function renderAll() {
        renderMonthTitle();
        renderFilters();
        renderRows();
        renderSummary();
        renderCalendar();
      }

      function undoPush(item) {
        undoStack.push(item);
        if (undoStack.length > 60) undoStack.shift();
      }

      function undo() {
        const it = undoStack.pop();
        if (!it) { toast('Geri alÄ±nacak iÅŸlem yok', 'info'); return; }
        const y = viewDate.getFullYear();
        const m = viewDate.getMonth();

        if (it.type === 'delete') {
          const { index, entry } = it.payload;
          entries.splice(Math.min(Math.max(index,0), entries.length), 0, normalizeEntry(entry, y, m));
          saveData();
          renderAll();
          toast('Geri alÄ±ndÄ±', 'ok');
          return;
        }

        if (it.type === 'update') {
          const { id, before } = it.payload;
          const idx = entries.findIndex(e => e.id === id);
          if (idx >= 0) {
            entries[idx] = normalizeEntry(before, y, m);
            saveData();
            renderAll();
            toast('Geri alÄ±ndÄ±', 'ok');
          }
        }
      }

      function quickAddParse(text) {
        const t = (text || '').trim();
        if (!t) return null;
        const parts = t.split(/\s+/);
        if (parts.length < 3) return null;

        let type = parts.some(p => p.toLowerCase() === 'gelir') ? 'gelir' : 'gider';
        if (parts.some(p => p.toLowerCase() === 'gider')) type = 'gider';

        const repeat = parts.some(p => p.toLowerCase() === 'aylÄ±k' || p.toLowerCase() === 'monthly') ? 'monthly' : 'none';

        let amount = null;
        let day = null;

        for (const p of parts) {
          const n = parseMoney(p);
          if (n.ok && amount === null) { amount = n.value; continue; }
          const di = Number.parseInt(p, 10);
          if (Number.isFinite(di) && di >= 1 && di <= 31 && day === null) day = di;
        }
        if (amount === null) return null;
        if (day === null) day = 1;

        const idxAmount = parts.findIndex(p => parseMoney(p).ok);
        const name = parts.slice(0, idxAmount).join(' ').trim() || 'Ä°ÅŸlem';
        return { name, amount, day, type, repeat };
      }

      function inferCategory(name) {
        const n = (name || '').toLowerCase();
        const rules = [
          { k:['kira'], c:'Kira' },
          { k:['elektrik','su','doÄŸalgaz','internet','telefon','fatura'], c:'Fatura' },
          { k:['market','migros','carrefour'], c:'Market' },
          { k:['yakÄ±t','akaryakÄ±t','benzin','dizel'], c:'UlaÅŸÄ±m' },
          { k:['yemek','restoran'], c:'Yemek' },
          { k:['kredi','taksit'], c:'Kredi' },
          { k:['altÄ±n','gram','Ã§eyrek'], c:'AltÄ±n' },
          { k:['maaÅŸ','prim'], c:'Gelir' }
        ];
        for (const r of rules) if (r.k.some(x=>n.includes(x)) && categories.includes(r.c)) return r.c;
        return categories.includes('Genel') ? 'Genel' : (categories[0] || 'Genel');
      }

      function addEntry(e) {
        const y = viewDate.getFullYear();
        const m = viewDate.getMonth();
        const ne = normalizeEntry({
          name: e.name,
          amount: e.amount,
          billDay: e.day,
          type: e.type,
          repeat: e.repeat,
          status: 'pending',
          category: e.type === 'gelir' ? 'Gelir' : inferCategory(e.name)
        }, y, m);
        entries.push(ne);
        saveData();
        renderAll();
        toast('Eklendi', 'ok');
      }

      function toggleSearchPanel() {
        const p = $('search_panel');
        const willShow = p.classList.contains('hidden');
        p.classList.toggle('hidden', !willShow);
        if (willShow) { const s = $('f_search'); if (s) s.focus(); }
      }

      async function driveRequest(url, options = {}) {
        if (!accessToken) throw new Error('NO_TOKEN');
        const res = await fetch(url, { ...options, headers: { ...(options.headers||{}), Authorization: `Bearer ${accessToken}` } });
        const txt = await res.text().catch(()=> '');
        if (!res.ok) throw new Error(`DRIVE_${res.status}: ${txt.slice(0,180)}`);
        const ct = res.headers.get('content-type') || '';
        if (ct.includes('application/json')) {
          try { return JSON.parse(txt || '{}'); } catch { return {}; }
        }
        return txt;
      }

      async function fetchUserInfo() {
        try {
          const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers:{ Authorization:`Bearer ${accessToken}` }});
          if (!res.ok) return;
          const user = await res.json();
          if (user?.email) { $('user-email').textContent = user.email; $('user-info').classList.remove('hidden'); }
          if (user?.picture) $('user-img').src = user.picture;
        } catch {}
      }

      async function findAppDataFileIdByName(name) {
        const q = encodeURIComponent(`name="${name}" and trashed=false`);
        const url = `https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&q=${q}&fields=files(id,name,modifiedTime)`;
        const data = await driveRequest(url);
        return (data?.files?.[0]?.id) || null;
      }

      function exportStateForDrive(withSnapshot=false) {
        const out = { schemaVersion: 2, months: {}, theme: localStorage.getItem(THEME_KEY) || 'light', categories, notify: localStorage.getItem(NOTIFY_KEY) || '0' };
        for (let i=0; i<localStorage.length; i++) {
          const k = localStorage.key(i);
          if (k && k.startsWith(STORAGE_PREFIX)) {
            const raw = localStorage.getItem(k);
            const parsed = safeJsonParse(raw, null);
            if (Array.isArray(parsed)) out.months[k] = parsed;
          }
        }
        if (withSnapshot) out.snapshots = [{ at: new Date().toISOString(), note:'autosave', monthsCount:Object.keys(out.months).length }];
        return out;
      }

      function applyDriveState(driveData) {
        const months = (driveData && typeof driveData === 'object' && driveData.months && typeof driveData.months === 'object') ? driveData.months : {};

        for (let i=localStorage.length-1; i>=0; i--) {
          const k = localStorage.key(i);
          if (k && k.startsWith(STORAGE_PREFIX)) localStorage.removeItem(k);
        }
        for (const [k,v] of Object.entries(months)) safeSetItem(k, JSON.stringify(v));

        if (driveData?.theme === 'dark' || driveData?.theme === 'light') {
          safeSetItem(THEME_KEY, driveData.theme);
          applyTheme(driveData.theme);
        }

        if (Array.isArray(driveData?.categories)) {
          categories = driveData.categories.filter(x=>typeof x==='string' && x.trim()).map(x=>x.trim());
          if (!categories.includes('Genel')) categories.unshift('Genel');
          if (!categories.includes('Gelir')) categories.push('Gelir');
          saveCategories();
        }

        if (driveData?.notify === '1' || driveData?.notify === '0') safeSetItem(NOTIFY_KEY, driveData.notify);

        loadData();
      }

      async function initDriveFile() {
        driveFileId = await findAppDataFileIdByName(DRIVE_BACKUP_NAME);
        if (driveFileId) return;

        const created = await driveRequest('https://www.googleapis.com/drive/v3/files?fields=id', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ name: DRIVE_BACKUP_NAME, parents:['appDataFolder'], mimeType:'application/json' })
        });

        driveFileId = created?.id || null;
        if (driveFileId) await syncToDrive(false);
      }

      async function syncToDrive(isAuto=false) {
        if (!driveFileId || !accessToken) return;
        const url = `https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=media`;
        await driveRequest(url, {
          method:'PATCH',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(exportStateForDrive(isAuto))
        });
        if (!isAuto) toast('Yedeklendi', 'ok');
      }

      async function syncFromDrive() {
        if (!driveFileId || !accessToken) return;
        const url = `https://www.googleapis.com/drive/v3/files/${driveFileId}?alt=media`;
        const raw = await driveRequest(url);
        const data = (typeof raw === 'string') ? safeJsonParse(raw, {}) : raw;
        applyDriveState(data);
        toast('Bulut eÅŸitlendi', 'info');
      }

      function formatMMSS(ms) {
        const t = Math.max(0, Math.ceil(ms/1000));
        const mm = String(Math.floor(t/60)).padStart(2,'0');
        const ss = String(t%60).padStart(2,'0');
        return `${mm}:${ss}`;
      }

      function setCountdownVisible(v) {
        $('session_badge').classList.toggle('hidden', !v);
      }

      function renderCountdown() {
        const left = sessionExpireAt - Date.now();
        $('session_countdown').textContent = formatMMSS(left);
      }

      function setSessionState(label) {
        $('session_state').textContent = label;
      }

      function stopCountdown() {
        if (countdownTimer) { clearInterval(countdownTimer); countdownTimer = null; }
        setCountdownVisible(false);
      }

      function startCountdown() {
        setCountdownVisible(true);
        renderCountdown();
        if (countdownTimer) clearInterval(countdownTimer);
        countdownTimer = setInterval(renderCountdown, 1000);
      }

      function clearSessionTimer() {
        if (sessionTimer) { clearTimeout(sessionTimer); sessionTimer = null; }
      }

      async function expireSession() {
        if (!sessionActive) return;
        sessionActive = false;
        clearSessionTimer();
        setSessionState('EXPIRED');
        renderCountdown();
        toast('Oturum sÃ¼resi doldu', 'err');
        await handleLogoutWithPrompt(true);
      }

      function armSessionTimer() {
        clearSessionTimer();
        sessionExpireAt = Date.now() + SESSION_TIMEOUT_MS;
        startCountdown();
        sessionTimer = setTimeout(expireSession, SESSION_TIMEOUT_MS);
      }

      function touchSessionInstant() {
        if (!sessionActive) return;
        setSessionState('ACTIVE');
        armSessionTimer();
      }

      function touchSessionFromMouseMove() {
        if (!sessionActive) return;
        const now = Date.now();
        if (now - lastMouseResetAt < MOUSE_RESET_THROTTLE_MS) { setSessionState('IDLE'); return; }
        lastMouseResetAt = now;
        setSessionState('ACTIVE');
        armSessionTimer();
      }

      function bindSessionActivity() {
        window.addEventListener('click', touchSessionInstant, { passive:true });
        window.addEventListener('keydown', touchSessionInstant, { passive:true });
        window.addEventListener('touchstart', touchSessionInstant, { passive:true });
        window.addEventListener('scroll', touchSessionInstant, { passive:true });
        window.addEventListener('mousemove', touchSessionFromMouseMove, { passive:true });
      }

      function initTokenClient() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: async (res) => {
            if (!res || res.error) { toast('GiriÅŸ hatasÄ±', 'err'); return; }
            accessToken = res.access_token;
            setAuthUi(true);

            sessionActive = true;
            setSessionState('ACTIVE');
            armSessionTimer();

            await fetchUserInfo();
            try { await initDriveFile(); toast('Drive hazÄ±r', 'ok'); } catch (e) { toast(String(e?.message || e), 'err'); }
          }
        });
      }

      function handleAuthClick() {
        if (!tokenClient) initTokenClient();
        tokenClient.requestAccessToken();
      }

      async function handleLogoutWithPrompt(isAuto=false) {
        const ask = isAuto
          ? 'Oturum sÃ¼resi doldu. Ã‡Ä±kmadan Ã¶nce buluta kaydedilsin mi?'
          : 'GÃ¼venli Ã§Ä±kÄ±ÅŸ. Ã‡Ä±kmadan Ã¶nce buluta kaydedilsin mi?';

        let doSave = false;
        try { doSave = confirm(ask); } catch { doSave = false; }

        if (doSave) {
          try { await syncToDrive(false); } catch (e) { toast(String(e?.message || e), 'err'); }
        }

        const token = accessToken;
        accessToken = null; driveFileId = null;

        sessionActive = false;
        clearSessionTimer();
        stopCountdown();

        if (!token) { location.reload(); return; }
        try { google.accounts.oauth2.revoke(token, () => location.reload()); }
        catch { location.reload(); }
      }

      async function handleLogout() { await handleLogoutWithPrompt(false); }

      function changeMonth(delta) {
        viewDate.setMonth(viewDate.getMonth() + delta);
        loadData();
      }

      function addBlankRow() {
        const y = viewDate.getFullYear();
        const m = viewDate.getMonth();
        entries.push(normalizeEntry({ name:'', amount:0, type:'gider', status:'pending', billDay:1, category:'Genel', repeat:'none' }, y, m));
        saveData();
        renderAll();
      }

      function buildYearlyTable(year) {
        const table = document.createElement('table');
        table.style.width='100%';
        table.style.borderCollapse='collapse';

        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        const heads = ['AY','GELÄ°R','GÄ°DER','GECÄ°KEN','NET'];
        for (const h of heads) {
          const th = document.createElement('th');
          th.textContent = h;
          trh.appendChild(th);
        }
        thead.appendChild(trh);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        let Tinc=0, Tout=0, Tover=0, Tnet=0;

        for (let mi=0; mi<12; mi++) {
          const data = safeLoadMonth(year, mi);
          const st = calculateMonth(data, year, mi);
          const inc = st.incPaid + st.incPending;
          const out = st.expPaid + st.expPending + st.expOver;

          Tinc += inc; Tout += out; Tover += st.expOver; Tnet += st.netForecast;

          const tr = document.createElement('tr');

          const tdAy = document.createElement('td'); tdAy.textContent = aylar[mi];
          const tdInc = document.createElement('td'); tdInc.textContent = `${inc.toLocaleString()} TL`;
          const tdOut = document.createElement('td'); tdOut.textContent = `${out.toLocaleString()} TL`;
          const tdOver = document.createElement('td'); tdOver.textContent = `${st.expOver.toLocaleString()} TL`;
          const tdNet = document.createElement('td');
          const b = document.createElement('b'); b.textContent = `${st.netForecast.toLocaleString()} TL`;
          tdNet.appendChild(b);

          tr.appendChild(tdAy);
          tr.appendChild(tdInc);
          tr.appendChild(tdOut);
          tr.appendChild(tdOver);
          tr.appendChild(tdNet);

          tbody.appendChild(tr);
        }

        const trT = document.createElement('tr');
        trT.style.background='var(--accent)';
        trT.style.color='white';

        const tdT = (txt) => {
          const td = document.createElement('td');
          const b = document.createElement('b'); b.textContent = txt;
          td.appendChild(b);
          return td;
        };

        trT.appendChild(tdT('TOPLAM'));
        trT.appendChild(tdT(`${Tinc.toLocaleString()} TL`));
        trT.appendChild(tdT(`${Tout.toLocaleString()} TL`));
        trT.appendChild(tdT(`${Tover.toLocaleString()} TL`));
        trT.appendChild(tdT(`${Tnet.toLocaleString()} TL`));

        tbody.appendChild(trT);
        table.appendChild(tbody);

        return table;
      }

      function bindEvents() {
        $('auth_btn').addEventListener('click', handleAuthClick);
        $('btn_backup').addEventListener('click', async () => { try { await syncToDrive(false); } catch (e) { toast(String(e?.message||e), 'err'); }});
        $('btn_logout').addEventListener('click', handleLogout);

        $('btn_theme').addEventListener('click', toggleTheme);
        $('btn_prev').addEventListener('click', () => changeMonth(-1));
        $('btn_next').addEventListener('click', () => changeMonth(1));

        $('btn_add').addEventListener('click', addBlankRow);

        $('btn_yearly').addEventListener('click', () => {
          const year = viewDate.getFullYear();
          $('yearly-title').textContent = `${year} YÄ±llÄ±k Ã–zet`;
          const host = $('yearly-content');
          host.textContent = '';
          host.appendChild(buildYearlyTable(year));
          showModal('yearlyModal');
        });

        $('btn_chart').addEventListener('click', () => {
          showModal('chartModal');
          toast('Grafikler modala hazÄ±r.', 'info');
        });

        $('btn_pdf').addEventListener('click', () => {
          const element = document.querySelector('.budget-card');
          const opt = { margin: 10, filename: `Butce_${aylar[viewDate.getMonth()]}_${viewDate.getFullYear()}.pdf`, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4' } };
          html2pdf().set(opt).from(element).save();
        });

        $('btn_settings').addEventListener('click', () => { renderCategoryChips(); showModal('settingsModal'); });
        $('btn_search').addEventListener('click', toggleSearchPanel);

        $('btn_quick_add').addEventListener('click', () => {
          const q = $('quick_input').value;
          const parsed = quickAddParse(q);
          if (!parsed) { toast('HÄ±zlÄ± ekleme formatÄ± hatalÄ±', 'err'); return; }
          $('quick_input').value = '';
          addEntry(parsed);
        });
        $('quick_input').addEventListener('keydown', (e) => { if (e.key === 'Enter') $('btn_quick_add').click(); });

        ['f_search','f_type','f_status','f_cat','f_sort'].forEach(id => {
          $(id).addEventListener('input', renderAll);
          $(id).addEventListener('change', renderAll);
        });

        document.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', () => closeModal(btn.getAttribute('data-close'))));
        ['chartModal','settingsModal','yearlyModal'].forEach(id => $(id).addEventListener('click', (e) => { if (e.target && e.target.id === id) closeModal(id); }));

        $('btn_reset').addEventListener('click', () => {
          const c1 = confirm('Yerel veriler silinecek. Emin misiniz?'); if (!c1) return;
          const c2 = confirm('Son onay. Silinsin mi?'); if (!c2) return;
          for (let i=localStorage.length-1; i>=0; i--) { const k = localStorage.key(i); if (k && k.startsWith(STORAGE_PREFIX)) localStorage.removeItem(k); }
          loadData();
          toast('Yerel veriler sÄ±fÄ±rlandÄ±', 'info');
        });

        $('btn_undo').addEventListener('click', undo);

        $('btn_add_cat').addEventListener('click', () => {
          const v = ($('cat_input').value || '').trim();
          if (!v) return;
          if (!categories.includes(v)) categories.push(v);
          $('cat_input').value = '';
          saveCategories();
          renderFilters();
          renderCategoryChips();
          renderAll();
          toast('Kategori eklendi', 'ok');
        });
        $('cat_input').addEventListener('keydown', (e) => { if (e.key === 'Enter') $('btn_add_cat').click(); });

        $('btn_notify').addEventListener('click', async () => {
          if (!('Notification' in window)) { toast('Bildirim desteklenmiyor', 'err'); return; }
          const p = await Notification.requestPermission();
          safeSetItem(NOTIFY_KEY, p === 'granted' ? '1' : '0');
          toast(p === 'granted' ? 'Bildirim aÃ§Ä±k' : 'Bildirim kapalÄ±', p === 'granted' ? 'ok' : 'info');
        });

        $('btn_sync').addEventListener('click', async () => {
          if (!accessToken || !driveFileId) { toast('Ã–nce Google ile baÄŸlan', 'err'); return; }
          try { await syncFromDrive(); } catch (e) { toast(String(e?.message||e), 'err'); }
        });
      }

      function init() {
        loadTheme();
        loadCategories();
        bindEvents();
        bindSessionActivity();

        setAuthUi(false);
        setCountdownVisible(false);

        initTokenClient();
        loadData();

        if (!localStorage.getItem(NOTIFY_KEY)) safeSetItem(NOTIFY_KEY, '0');
      }

      window.addEventListener('load', init);
    })();
  </script>
</body>
</html>

