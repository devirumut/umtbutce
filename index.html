<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√ºt√ße Pro Planlayƒ±cƒ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --primary: #f8fafc; --card-bg: #ffffff; --accent: #4f46e5;
            --income: #22c55e; --expense: #f43f5e; --pending: #f59e0b;
            --text-main: #1e293b; --text-dim: #64748b; --border: #e2e8f0;
        }
        [data-theme="dark"] {
            --primary: #0f172a; --card-bg: #1e293b; --accent: #818cf8;
            --text-main: #f1f5f9; --text-dim: #94a3b8; --border: #334155;
        }
        body {
            font-family: 'Poppins', sans-serif; background-color: var(--primary);
            color: var(--text-main); margin: 0; padding: 10px; transition: all 0.3s ease;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }
        .app-header {
            width: 100%; max-width: 1750px; display: flex; justify-content: space-between; align-items: center;
            padding: 10px 25px; background: var(--card-bg); border-radius: 15px; 
            margin-bottom: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: 1px solid var(--border); box-sizing: border-box;
        }
        .header-left, .header-right { display: flex; align-items: center; gap: 12px; }
        
        .main-layout { display: grid; grid-template-columns: 650px 1fr; gap: 20px; width: 100%; max-width: 1750px; margin-bottom: 15px; }
        .left-panel { display: flex; flex-direction: column; gap: 10px; }
        .widget-card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        .widget-header { background: #f1f5f9; padding: 6px 15px; font-size: 0.7rem; font-weight: 600; color: #64748b; text-transform: uppercase; }
        [data-theme="dark"] .widget-header { background: #334155; color: #cbd5e1; }
        
        .crop-box { height: 42px; overflow: hidden; position: relative; background: #fff; }
        .crop-box iframe { border: none; width: 2400px; height: 5000px; position: absolute; transform: scale(0.63); transform-origin: 0 0; }
        #frame-gram { top: -260px; left: -25px; } #frame-ceyrek { top: -182px; left: -775px; }
        .currency-box { height: 78px; } #frame-doviz { top: -184px; left: -25px; }
        
        .budget-card { background: var(--card-bg); padding: 20px 30px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.04); position: relative; }
        .sticky-controls { position: sticky; top: 0; background: var(--card-bg); z-index: 100; padding-bottom: 15px; border-bottom: 1px solid var(--border); margin-bottom: 15px; }
        
        .entry-row { display: grid; grid-template-columns: 35px 1.5fr 0.7fr 0.6fr 100px 30px; gap: 8px; margin-bottom: 8px; align-items: center; transition: 0.2s; }
        .entry-row.hidden { display: none; }
        input, select { background: var(--primary); border: 1.5px solid var(--border); padding: 8px; border-radius: 8px; font-size: 12px; color: var(--text-main); outline: none; width: 100%; box-sizing: border-box; }
        
        .status-badge { display: flex; align-items: center; justify-content: center; height: 30px; border-radius: 8px; cursor: pointer; font-size: 8px; font-weight: 700; background: var(--primary); border: 1px solid var(--border); }
        .badge-paid { background: #dcfce7 !important; color: #166534 !important; }
        .badge-pending { background: #fef3c7 !important; color: #92400e !important; }
        .badge-received { background: #e0f2fe !important; color: #075985 !important; }
        .badge-awaiting { background: #f1f5f9 !important; color: #475569 !important; }
        
        .btn-action { background: var(--accent); color: white; border: none; padding: 8px 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 11px; transition: 0.2s; }
        .btn-tool { background: #f1f5f9; color: #1e293b; border: 1px solid var(--border); }
        .btn-danger { background: #ef4444 !important; color: white !important; }
        
        .notification-bar { width: 100%; max-width: 1750px; margin-bottom: 10px; display: none; background: #fee2e2; border: 1px solid #fecaca; padding: 10px 20px; border-radius: 10px; color: #991b1b; font-size: 12px; font-weight: 600; box-sizing: border-box; }

        .modal-overlay { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 20px; border: 1px solid var(--border); width: 95%; max-width: 700px; max-height: 85vh; overflow-y: auto; position: relative; }
        .modal-close-x { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: var(--text-dim); border: none; background: none; }

        .toast-msg { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); padding: 14px 28px; border-radius: 12px; color: white; font-weight: 500; font-size: 13px; z-index: 9999; transition: 0.4s; display: flex; gap: 10px; }
        .toast-msg.show { transform: translateX(-50%) translateY(0); }

        .calendar-section { width: 100%; max-width: 1750px; background: var(--card-bg); padding: 15px 25px; border-radius: 20px; border: 1px solid var(--border); margin-top: 15px; box-sizing: border-box; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 10px; }
        .cal-day { background: var(--primary); border: 1px solid var(--border); min-height: 60px; border-radius: 10px; padding: 5px; }
        
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 20px; }
        .stat-item { padding: 12px; border-radius: 14px; background: var(--primary); border: 1px solid var(--border); }
        
        .filter-search { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
        .filter-search input { flex: 1; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border); font-size: 12px; }

        .footer-copyright { margin-top: 20px; margin-bottom: 20px; font-size: 10px; color: var(--text-dim); opacity: 0.6; }
    </style>
</head>
<body>

<div id="notif-bar" class="notification-bar"></div>

<div class="app-header">
    <div class="header-left">
        <h1 style="font-size: 1.2rem; margin:0;">B√ºt√ße Pro Planlayƒ±cƒ± <span style="font-size:10px; opacity:0.5;">V4</span></h1>
        <div id="user-info" style="display:none; align-items:center; gap:8px;">
            <img id="user-img" src="" style="width:24px; height:24px; border-radius:50%;">
            <span id="user-email" style="font-size:11px; font-weight:600;"></span>
        </div>
    </div>
    <div class="header-right">
        <button id="auth_btn" class="btn-action" onclick="handleAuthClick()">Google Baƒülan</button>
        <div id="auth_controls" style="display:none; gap:8px;">
            <button class="btn-action" onclick="syncToDrive()" style="background:#22c55e;">Yedekle</button>
            <button class="btn-action" onclick="handleLogout()" style="background:#64748b;">√áƒ±kƒ±≈ü</button>
        </div>
        <button onclick="toggleTheme()" class="btn-action btn-tool">üåì</button>
    </div>
</div>

<div class="main-layout">
    <div class="left-panel">
        <div class="widget-card"><div class="widget-header">ALTIN (GRAM/√áEYREK)</div><div class="crop-box"><iframe src="https://www.altinkaynak.com/canli-kurlar/altin" id="frame-gram"></iframe></div></div>
        <div class="widget-card"><div class="widget-header">D√ñVƒ∞Z KURLARI</div><div class="crop-box currency-box"><iframe src="https://www.altinkaynak.com/canli-kurlar/doviz" id="frame-doviz"></iframe></div></div>
        
        <div class="widget-card" style="padding:15px;">
            <div style="font-size:11px; font-weight:700; color:var(--text-dim); margin-bottom:10px;">üí∞ TASARRUF HEDEFƒ∞</div>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:11px;">
                <span>Hedef: <input type="number" id="goal-val" style="width:70px; padding:2px;" onchange="saveGoal(this.value)"> TL</span>
                <span id="goal-perc" style="font-weight:700; color:var(--income);">%0</span>
            </div>
            <div style="width:100%; background:#e2e8f0; height:6px; border-radius:3px; overflow:hidden;"><div id="goal-fill" style="height:100%; background:var(--income); width:0%; transition:1s;"></div></div>
        </div>
    </div>

    <div class="budget-card">
        <div class="sticky-controls">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <button onclick="changeMonth(-1)" class="btn-action">‚ùÆ</button>
                    <span id="display-month" style="font-weight:700; min-width:120px; text-align:center;"></span>
                    <button onclick="changeMonth(1)" class="btn-action">‚ùØ</button>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="btn-action btn-tool" onclick="generateYearlyReport()">üìÖ Yƒ±llƒ±k</button>
                    <button class="btn-action btn-tool" onclick="showChart()">üìà Analiz</button>
                    <button class="btn-action btn-tool" onclick="exportPDF()">üìÑ PDF</button>
                    <button class="btn-action btn-tool" onclick="renderSettings(); showModal('settingsModal')">‚öôÔ∏è</button>
                </div>
            </div>
            
            <div class="filter-search">
                <input type="text" id="searchInput" placeholder="ƒ∞≈ülem ara..." oninput="filterEntries()">
                <select id="filterType" style="width:100px;" onchange="filterEntries()">
                    <option value="all">T√ºm√º</option>
                    <option value="gelir">Gelirler</option>
                    <option value="gider">Giderler</option>
                    <option value="pending">Bekleyenler</option>
                </select>
            </div>

            <div id="progress-text" style="font-size:10px; font-weight:600; color:var(--text-dim); margin-bottom:5px;">HARCAMA ORANI: %0</div>
            <div style="width:100%; background:#e2e8f0; height:8px; border-radius:4px; overflow:hidden;"><div id="progress-fill" style="height:100%; background:var(--accent); width:0%; transition:0.5s;"></div></div>
        </div>

        <div id="entries-container"></div>
        <button class="btn-action" style="width:100%; margin-top:10px; background:none; border: 1px dashed var(--accent); color:var(--accent);" onclick="addRow()">+ Yeni ƒ∞≈ülem Ekle</button>
        
        <div class="summary-grid" id="pdf-summary">
            <div class="stat-item"><small>GELƒ∞R</small><div id="t-inc" style="color:var(--income); font-weight:700;">0 TL</div></div>
            <div class="stat-item"><small>Gƒ∞DER</small><div id="t-exp" style="color:var(--expense); font-weight:700;">0 TL</div></div>
            <div class="stat-item"><small>BEKLEYEN</small><div id="t-pend" style="color:var(--pending); font-weight:700;">0 TL</div></div>
            <div class="stat-item" style="background:var(--accent); color:white;"><small>NET KALAN</small><div id="t-net" style="font-weight:700;">0 TL</div></div>
        </div>
    </div>
</div>

<div class="calendar-section">
    <div style="font-weight:700; font-size:0.9rem; margin-bottom:10px;">üìÖ √ñdeme Takvimi</div>
    <div class="calendar-grid" id="calendar-body"></div>
</div>

<div class="footer-copyright">umtdvr | Checkpoint V4</div>

<div id="chartModal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-x" onclick="closeModal('chartModal')">√ó</button>
        <h3>Harcanan vs Kalan</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <canvas id="budgetChart"></canvas>
            <canvas id="lineChart"></canvas>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-x" onclick="closeModal('settingsModal')">√ó</button>
        <h3>Ayarlar</h3>
        <div style="font-size: 11px; font-weight: 700; color: var(--text-dim); margin-bottom: 10px;">√ñDEME G√úNLERƒ∞</div>
        <div id="settings-list"></div>
        <hr style="border: none; border-top: 1px solid var(--border); margin: 20px 0;">
        <button class="btn-action btn-danger" style="width:100%;" onclick="hardResetData()">T√ºm Verileri Sƒ±fƒ±rla</button>
    </div>
</div>

<div id="yearlyModal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-x" onclick="closeModal('yearlyModal')">√ó</button>
        <h3>Yƒ±llƒ±k Analiz (2026)</h3>
        <div id="yearly-content"></div>
    </div>
</div>

<script>
    const CLIENT_ID = '874591165323-ktdp2ojebh4225v0335lvuk3pct8eraq.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/userinfo.email';
    let accessToken = null, driveFileId = null, myChart = null, myLineChart = null;
    const aylar = ["OCAK", "≈ûUBAT", "MART", "Nƒ∞SAN", "MAYIS", "HAZƒ∞RAN", "TEMMUZ", "AƒûUSTOS", "EYL√úL", "EKƒ∞M", "KASIM", "ARALIK"];
    let viewDate = new Date(), entries = [];

    const iconMap = { 'maa≈ü': 'üí∞', 'kira': 'üè†', 'market': 'üõí', 'fatura': 'üìÑ', 'elektrik': '‚ö°', 'su': 'üíß', 'doƒüalgaz': 'üî•', 'internet': 'üåê', 'f√∂n': 'üíá', 'akaryakƒ±t': '‚õΩ', 'kredi': 'üí≥' };
    function getIcon(n) { n = (n || "").toLowerCase(); for (let k in iconMap) if (n.includes(k)) return iconMap[k]; return 'üëõ'; }

    function loadData() {
        const key = `butce_${aylar[viewDate.getMonth()]}_${viewDate.getFullYear()}`;
        const stored = localStorage.getItem(key);
        entries = stored ? JSON.parse(stored) : [{ name: '', amount: 0, type: 'gelir', status: 'pending', billDay: 1 }];
        document.getElementById('goal-val').value = localStorage.getItem('savings_goal') || 0;
        renderInitial();
        checkNotifications();
    }

    function renderInitial() {
        document.getElementById('display-month').innerText = aylar[viewDate.getMonth()] + " " + viewDate.getFullYear();
        const container = document.getElementById('entries-container');
        container.innerHTML = ''; 
        entries.forEach((item, index) => {
            const row = document.createElement('div'); 
            row.className = 'entry-row';
            row.id = `row-${index}`;
            const isG = item.type === 'gelir';
            row.innerHTML = `
                <div style="font-size:18px;">${getIcon(item.name)}</div>
                <input type="text" value="${item.name}" placeholder="ƒ∞≈ülem adƒ±" oninput="updateItem(${index}, 'name', this.value); this.parentElement.firstElementChild.innerText=getIcon(this.value)">
                <input type="number" value="${item.amount || ''}" placeholder="0" oninput="updateItem(${index}, 'amount', this.value)">
                <select onchange="updateItem(${index}, 'type', this.value); renderInitial();">
                    <option value="gelir" ${isG ? 'selected' : ''}>Gelir</option>
                    <option value="gider" ${!isG ? 'selected' : ''}>Gider</option>
                </select>
                <div class="status-badge ${isG ? (item.status==='paid'?'badge-received':'badge-awaiting') : (item.status==='paid'?'badge-paid':'badge-pending')}" onclick="toggleStatus(${index})">
                    ${isG ? (item.status==='paid'?'ALINDI':'BEKLE') : (item.status==='paid'?'√ñDENDƒ∞':'BEKLE')}
                </div>
                <button style="border:none; background:none; color:var(--text-dim); cursor:pointer;" onclick="removeRow(${index})">√ó</button>`;
            container.appendChild(row);
        });
        calculate(); renderCalendar();
    }

    function calculate() {
        let inc = 0, exp = 0, pend = 0;
        entries.forEach(i => {
            if(i.type === 'gelir') inc += i.amount;
            else if(i.status === 'paid') exp += i.amount;
            else pend += i.amount;
        });
        const totalOut = exp + pend;
        const net = inc - totalOut;
        document.getElementById('t-inc').innerText = inc.toLocaleString() + " TL";
        document.getElementById('t-exp').innerText = exp.toLocaleString() + " TL";
        document.getElementById('t-pend').innerText = pend.toLocaleString() + " TL";
        document.getElementById('t-net').innerText = net.toLocaleString() + " TL";
        
        const perc = inc > 0 ? Math.min((totalOut / inc) * 100, 100) : 0;
        document.getElementById('progress-fill').style.width = perc + "%";
        document.getElementById('progress-text').innerText = `HARCAMA ORANI: %${perc.toFixed(1)}`;

        // Hedef Hesaplama
        const goal = parseFloat(localStorage.getItem('savings_goal')) || 0;
        if(goal > 0) {
            const goalPerc = Math.min((net / goal) * 100, 100);
            document.getElementById('goal-fill').style.width = Math.max(0, goalPerc) + "%";
            document.getElementById('goal-perc').innerText = `%${Math.max(0, goalPerc).toFixed(0)}`;
        }
    }

    function checkNotifications() {
        const today = new Date().getDate();
        const approaching = entries.filter(e => e.type === 'gider' && e.status !== 'paid' && e.billDay >= today && e.billDay <= today + 2);
        const bar = document.getElementById('notif-bar');
        if(approaching.length > 0) {
            bar.innerHTML = `‚ö†Ô∏è <b>Hatƒ±rlatma:</b> √ñn√ºm√ºzdeki 48 saat i√ßinde ${approaching.length} adet √∂demeniz bulunuyor (${approaching.map(a => a.name).join(', ')}).`;
            bar.style.display = 'block';
        } else {
            bar.style.display = 'none';
        }
    }

    function filterEntries() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        const type = document.getElementById('filterType').value;
        entries.forEach((item, index) => {
            const row = document.getElementById(`row-${index}`);
            const matchName = item.name.toLowerCase().includes(term);
            const matchType = (type === 'all') || (type === item.type) || (type === 'pending' && item.status === 'pending');
            row.style.display = (matchName && matchType) ? 'grid' : 'none';
        });
    }

    function exportPDF() {
        const element = document.querySelector('.budget-card');
        const opt = { margin: 10, filename: `Butce_Raporu_${aylar[viewDate.getMonth()]}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
        html2pdf().set(opt).from(element).save();
        showToast("PDF Hazƒ±rlanƒ±yor...", "success");
    }

    function saveGoal(val) { localStorage.setItem('savings_goal', val); calculate(); }

    function showChart() {
        showModal('chartModal');
        const ctxD = document.getElementById('budgetChart').getContext('2d');
        const ctxL = document.getElementById('lineChart').getContext('2d');
        
        if (myChart) myChart.destroy();
        if (myLineChart) myLineChart.destroy();

        // Pasta Grafik
        let labels = [], data = [];
        entries.filter(e => e.type === 'gider').forEach(e => { labels.push(e.name); data.push(e.amount); });
        myChart = new Chart(ctxD, { type: 'doughnut', data: { labels, datasets: [{ data, backgroundColor: ['#4f46e5', '#f43f5e', '#f59e0b', '#22c55e', '#06b6d4', '#8b5cf6'] }] }});

        // √áizgi Grafik (Son 6 Ay Sim√ºlasyonu)
        myLineChart = new Chart(ctxL, {
            type: 'line',
            data: {
                labels: aylar.slice(0, 6),
                datasets: [{ label: 'Harcama Trendi', data: [12000, 15000, 11000, 18000, 14000, 16000], borderColor: '#4f46e5', tension: 0.4 }]
            }
        });
    }

    // Ortak Fonksiyonlar (V3'ten korunanlar)
    function updateItem(i, k, v) { 
        entries[i][k] = (k==='amount' || k==='billDay') ? parseFloat(v)||0 : v; 
        localStorage.setItem(`butce_${aylar[viewDate.getMonth()]}_${viewDate.getFullYear()}`, JSON.stringify(entries));
        calculate(); 
        if(['billDay', 'name', 'status'].includes(k)) renderCalendar();
    }
    function toggleStatus(i) { entries[i].status = entries[i].status === 'paid' ? 'pending' : 'paid'; updateItem(i, 'status', entries[i].status); renderInitial(); }
    function changeMonth(s) { viewDate.setMonth(viewDate.getMonth() + s); loadData(); }
    function addRow() { entries.push({ name: '', amount: 0, type: 'gider', status: 'pending', billDay: 1 }); renderInitial(); }
    function showModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function toggleTheme() { const t = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; document.body.setAttribute('data-theme', t); }
    function showToast(m, type='info') {
        const t = document.createElement('div'); t.className = `toast-msg toast-${type}`;
        t.style.background = type === 'success' ? '#10b981' : '#4f46e5';
        t.innerHTML = m; document.body.appendChild(t);
        setTimeout(() => t.classList.add('show'), 100);
        setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 500); }, 3000);
    }
    function renderCalendar() {
        const body = document.getElementById('calendar-body'); body.innerHTML = '';
        const days = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
        for (let d = 1; d <= days; d++) {
            const dayDiv = document.createElement('div'); dayDiv.className = 'cal-day';
            dayDiv.innerHTML = `<span style="font-size:10px; font-weight:700;">${d}</span>`;
            entries.filter(e => e.type === 'gider' && e.billDay === d).forEach(ev => {
                dayDiv.innerHTML += `<div style="font-size:7px; background:${ev.status==='paid'?'#dcfce7':'#fef3c7'}; padding:2px; border-radius:3px; margin-top:2px;">${ev.name}</div>`;
            });
            body.appendChild(dayDiv);
        }
    }
    function renderSettings() {
        const list = document.getElementById('settings-list'); list.innerHTML = '';
        entries.filter(e => e.type === 'gider').forEach((item) => {
            const idx = entries.indexOf(item);
            const div = document.createElement('div');
            div.style = "display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid var(--border); font-size:12px;";
            div.innerHTML = `<span>${item.name || 'ƒ∞simsiz'}</span><input type="number" value="${item.billDay}" min="1" max="31" oninput="updateItem(${idx}, 'billDay', this.value)" style="width:40px;">`;
            list.appendChild(div);
        });
    }

    function hardResetData() {
        if(confirm("T√ºm veriler silinecek! Onaylƒ±yor musunuz?")) {
            localStorage.clear(); location.reload();
        }
    }

    window.onload = loadData;
</script>
</body>
</html>
