<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>B√ºt√ße Planlama Uygulamasƒ± V3.2 (Minimal)</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --primary:#f8fafc;
      --card-bg:#ffffff;
      --accent:#4f46e5;
      --income:#22c55e;
      --expense:#f43f5e;
      --pending:#f59e0b;
      --text-main:#0f172a;
      --text-dim:#64748b;
      --border:#e2e8f0;
      --soft:#f1f5f9;
      --shadow:0 8px 28px rgba(2,6,23,.06);
    }
    [data-theme="dark"]{
      --primary:#0f172a;
      --card-bg:#111c33;
      --accent:#818cf8;
      --text-main:#f1f5f9;
      --text-dim:#94a3b8;
      --border:#233052;
      --soft:#162341;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    body{
      font-family:'Poppins',sans-serif;
      background:var(--primary);
      color:var(--text-main);
      margin:0;
      padding:10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
    }

    .app-header{
      width:100%;
      max-width:1750px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:10px 18px;
      background:var(--card-bg);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      margin-bottom:12px;
    }
    .header-left,.header-right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .title{
      font-size:1.05rem;
      margin:0;
      letter-spacing:-.2px;
    }
    .title small{ font-size:10px; opacity:.55; font-weight:700; margin-left:6px; }

    .google-btn{
      display:flex; align-items:center; gap:10px;
      background:white; color:#3c4043;
      border:1px solid #dadce0;
      padding:8px 12px; border-radius:10px;
      font-weight:600; font-size:12px;
      cursor:pointer; transition:.15s;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
    }
    .google-btn:hover{ background:#f8f9fa; }
    .google-btn img{ width:18px; height:18px; }

    .btn{
      border:1px solid var(--border);
      background:var(--soft);
      color:var(--text-main);
      padding:8px 10px;
      border-radius:12px;
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      transition:.15s;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{ filter:brightness(.98); }
    .btn.primary{ background:var(--accent); color:white; border-color:transparent; }
    .btn.good{ background:var(--income); color:white; border-color:transparent; }
    .btn.gray{ background:#64748b; color:white; border-color:transparent; }
    .btn.icon{ width:40px; height:40px; padding:0; justify-content:center; }

    #user-info{
      display:none; align-items:center; gap:8px;
      padding:6px 10px;
      border:1px solid var(--border);
      background:var(--soft);
      border-radius:12px;
      font-size:11px;
      font-weight:700;
      color:var(--text-dim);
      max-width:340px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    #user-img{ width:22px; height:22px; border-radius:999px; }

    .main-layout{
      width:100%;
      max-width:1750px;
      display:grid;
      grid-template-columns:650px 1fr;
      gap:14px;
      align-items:start;
      margin-bottom:12px;
    }
    @media (max-width:1200px){
      .main-layout{ grid-template-columns:1fr; }
    }

    /* SOL TARAFI DEƒûƒ∞≈ûTƒ∞RME: orijinal widget yapƒ±sƒ± */
    .left-panel{ display:flex; flex-direction:column; gap:10px; }
    .widget-card{ background:var(--card-bg); border-radius:12px; border:1px solid var(--border); overflow:hidden; box-shadow:var(--shadow); }
    .widget-header{ background:#f1f5f9; padding:6px 15px; font-size:.7rem; font-weight:600; color:#64748b; text-transform:uppercase; }
    [data-theme="dark"] .widget-header{ background:#1c2a4a; color:#cbd5e1; }
    .crop-box{ height:42px; overflow:hidden; position:relative; background:#fff; }
    .crop-box iframe{ border:none; width:2400px; height:5000px; position:absolute; transform:scale(0.63); transform-origin:0 0; }
    #frame-gram{ top:-260px; left:-25px; }
    #frame-ceyrek{ top:-182px; left:-775px; }
    .currency-box{ height:78px; }
    #frame-doviz{ top:-184px; left:-25px; }

    /* Saƒü kart */
    .budget-card{
      background:var(--card-bg);
      padding:16px 16px 14px 16px;
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      position:relative;
    }
    .sticky-controls{
      position:sticky;
      top:0;
      z-index:50;
      background:var(--card-bg);
      padding-bottom:12px;
      border-bottom:1px solid var(--border);
      margin-bottom:12px;
    }
    .toprow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .month-nav{
      display:flex; align-items:center; gap:8px;
      padding:6px 10px;
      border:1px solid var(--border);
      background:var(--soft);
      border-radius:14px;
    }
    #display-month{ font-weight:800; font-size:12px; min-width:140px; text-align:center; color:var(--text-main); }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    /* Arama paneli (ikonla a√ßƒ±lƒ±r) */
    .search-panel{
      display:none;
      margin-top:10px;
      padding:10px;
      border:1px solid var(--border);
      background:var(--soft);
      border-radius:14px;
      gap:8px;
      grid-template-columns: 1.2fr .7fr .7fr .8fr .9fr;
      align-items:center;
    }
    @media (max-width:1000px){
      .search-panel{ grid-template-columns: 1fr 1fr; }
    }
    .search-panel input,.search-panel select{
      width:100%;
      background:var(--card-bg);
      border:1px solid var(--border);
      padding:9px 10px;
      border-radius:12px;
      font-size:12px;
      color:var(--text-main);
      outline:none;
    }

    .progress-text{
      font-size:10px; font-weight:700; color:var(--text-dim);
      margin-bottom:6px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .bar{
      width:100%;
      background:#e2e8f0;
      height:8px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.20);
    }
    [data-theme="dark"] .bar{ background:#14213f; border-color:#223155; }
    #progress-fill{
      height:100%;
      background:var(--accent);
      width:0%;
      transition:0.35s;
    }

    .entry-row{
      display:grid;
      grid-template-columns: 40px 1.6fr .8fr .7fr 150px .9fr 34px;
      gap:8px;
      margin-bottom:8px;
      align-items:center;
    }
    @media (max-width:1000px){
      .entry-row{ grid-template-columns: 40px 1fr .8fr .7fr 130px 34px; }
      .hide-mobile{ display:none; }
    }

    input, select{
      background:var(--primary);
      border:1.5px solid var(--border);
      padding:9px 10px;
      border-radius:12px;
      font-size:12px;
      color:var(--text-main);
      outline:none;
    }

    /* ikon g√∂r√ºnmeme sorunu: emoji font fallbacks */
    .icon-box{
      font-size:18px;
      width:40px; height:38px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--border);
      background:var(--soft);
      border-radius:14px;
      font-family: "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",emoji, sans-serif;
    }

    .status-badge{
      display:flex; align-items:center; justify-content:center;
      height:38px;
      border-radius:12px;
      cursor:pointer;
      font-size:10px;
      font-weight:800;
      background:var(--primary);
      border:1px solid var(--border);
      user-select:none;
    }
    .badge-paid{ background:#dcfce7 !important; color:#166534 !important; border-color:#bbf7d0 !important; }
    .badge-pending{ background:#fef3c7 !important; color:#92400e !important; border-color:#fde68a !important; }
    .badge-received{ background:#e0f2fe !important; color:#075985 !important; border-color:#bae6fd !important; }
    .badge-awaiting{ background:#f1f5f9 !important; color:#475569 !important; border-color:#e2e8f0 !important; }

    .mini{
      height:38px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--border);
      background:var(--soft);
      border-radius:12px;
      cursor:pointer;
      color:var(--text-dim);
      font-size:18px;
      user-select:none;
    }

    .add-btn{
      width:100%;
      margin-top:10px;
      background:none;
      border:1px dashed var(--accent);
      color:var(--accent);
      padding:10px 12px;
      border-radius:14px;
      font-weight:800;
      cursor:pointer;
    }

    .summary-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:14px;
    }
    @media (max-width:900px){
      .summary-grid{ grid-template-columns: 1fr 1fr; }
    }
    .stat-item{
      padding:12px;
      border-radius:16px;
      background:var(--soft);
      border:1px solid var(--border);
    }
    .stat-item small{ color:var(--text-dim); font-weight:800; font-size:10px; letter-spacing:.3px; }
    .stat-item div{ margin-top:6px; font-weight:900; }
    .stat-net{ background:var(--accent); border-color:transparent; color:white; }
    .stat-net small{ color:rgba(255,255,255,.75); }

    /* Takvim */
    .calendar-section{
      width:100%;
      max-width:1750px;
      background:var(--card-bg);
      padding:14px 16px;
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
    }
    .calendar-grid{
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:6px;
      margin-top:10px;
    }
    @media (max-width:1000px){
      .calendar-grid{ grid-template-columns:repeat(4, 1fr); }
    }
    @media (max-width:520px){
      .calendar-grid{ grid-template-columns:repeat(2, 1fr); }
    }
    .cal-day{
      background:var(--soft);
      border:1px solid var(--border);
      min-height:74px;
      border-radius:14px;
      padding:6px;
      overflow:hidden;
    }
    .cal-day span{ font-size:10px; font-weight:900; color:var(--text-dim); }
    .cal-ev{
      font-size:9px;
      font-weight:800;
      padding:4px 6px;
      border-radius:10px;
      margin-top:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      border:1px solid rgba(2,6,23,.06);
    }
    [data-theme="dark"] .cal-ev{ border-color: rgba(255,255,255,.06); }

    /* Modals */
    .modal-overlay{
      display:none;
      position:fixed;
      z-index:2000;
      left:0; top:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.6);
      backdrop-filter: blur(5px);
      justify-content:center;
      align-items:center;
      padding:12px;
    }
    .modal-content{
      background:var(--card-bg);
      padding:16px;
      border-radius:18px;
      border:1px solid var(--border);
      width: min(680px, 96vw);
      max-height: 86vh;
      overflow:auto;
      position:relative;
      box-shadow:var(--shadow);
    }
    .modal-close-x{
      position:absolute;
      top:10px; right:10px;
      width:40px; height:40px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--soft);
      cursor:pointer;
      font-size:22px;
      color:var(--text-dim);
    }

    /* Grafik: daha k√º√ß√ºk */
    .chart-wrap{
      width:100%;
      max-width:420px;
      height:240px;
      margin:0 auto;
      padding:10px;
      border:1px solid var(--border);
      border-radius:16px;
      background:var(--soft);
    }

    /* Settings list */
    .settings-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid var(--border);
      gap:10px;
    }
    .danger-box{
      background:#fff1f2;
      border:1px solid #fecaca;
      padding:12px;
      border-radius:14px;
      margin-top:12px;
    }
    [data-theme="dark"] .danger-box{
      background:#2a0b12;
      border-color:#7f1d1d;
    }
    .footer-copyright{
      margin:14px 0 18px;
      font-size:10px;
      color:var(--text-dim);
      opacity:0.6;
    }

    /* Toast */
    .toast-msg{
      position:fixed;
      bottom:22px;
      left:50%;
      transform:translateX(-50%) translateY(100px);
      padding:12px 16px;
      border-radius:14px;
      color:white;
      font-weight:700;
      font-size:12px;
      z-index:9999;
      transition:0.35s;
    }
    .toast-msg.show{ transform:translateX(-50%) translateY(0); }
    .toast-info{ background:var(--accent); }
    .toast-success{ background:var(--income); }
    .toast-error{ background:var(--expense); }
  </style>
</head>

<body>
  <div class="app-header">
    <div class="header-left">
      <h1 class="title">B√ºt√ße Planlama <small>V3.2 Minimal</small></h1>

      <div id="user-info">
        <img id="user-img" src="" alt="user">
        <span id="user-email"></span>
      </div>
    </div>

    <div class="header-right">
      <button id="auth_btn" class="google-btn" type="button" onclick="handleAuthClick()">
        <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" alt="Google"> Google ile Baƒülan
      </button>

      <div id="auth_controls" style="display:none; gap:8px; align-items:center;">
        <button class="btn good" type="button" onclick="syncToDrive()">‚òÅÔ∏è Yedekle</button>
        <button class="btn gray" type="button" onclick="handleLogout()">üîí √áƒ±kƒ±≈ü</button>
      </div>

      <button class="btn icon" type="button" onclick="toggleTheme()" title="Tema">üåì</button>
    </div>
  </div>

  <div class="main-layout">
    <!-- SOL TARAFI DEƒûƒ∞≈ûTƒ∞RME -->
    <div class="left-panel">
      <div class="widget-card">
        <div class="widget-header">24 AYAR GRAM</div>
        <div class="crop-box"><iframe src="https://www.altinkaynak.com/canli-kurlar/altin" id="frame-gram"></iframe></div>
      </div>

      <div class="widget-card">
        <div class="widget-header">√áEYREK ALTIN</div>
        <div class="crop-box"><iframe src="https://www.altinkaynak.com/canli-kurlar/altin" id="frame-ceyrek"></iframe></div>
      </div>

      <div class="widget-card">
        <div class="widget-header">DOLAR & EURO</div>
        <div class="crop-box currency-box"><iframe src="https://www.altinkaynak.com/canli-kurlar/doviz" id="frame-doviz"></iframe></div>
      </div>
    </div>

    <!-- SAƒû -->
    <div class="budget-card">
      <div class="sticky-controls">
        <div class="toprow">
          <div class="month-nav">
            <button class="btn icon" type="button" onclick="changeMonth(-1)" title="√ñnceki Ay">‚ùÆ</button>
            <span id="display-month">‚Äî</span>
            <button class="btn icon" type="button" onclick="changeMonth(1)" title="Sonraki Ay">‚ùØ</button>
          </div>

          <div class="toolbar">
            <button class="btn icon" type="button" onclick="toggleSearch()" title="Ara">üîé</button>
            <button class="btn icon" type="button" onclick="generateYearlyReport()" title="Yƒ±llƒ±k Analiz">üóìÔ∏è</button>
            <button class="btn icon" type="button" onclick="showChart()" title="Grafik">üìä</button>
            <button class="btn icon" type="button" onclick="exportPDF()" title="PDF">üìÑ</button>
            <button class="btn icon" type="button" onclick="renderSettings(); showModal('settingsModal')" title="Ayarlar">‚öôÔ∏è</button>
          </div>
        </div>

        <div id="search-panel" class="search-panel">
          <input id="f-q" placeholder="Ara: i≈ülem adƒ±">
          <select id="f-type">
            <option value="all">T√ºr: Hepsi</option>
            <option value="gelir">T√ºr: Gelir</option>
            <option value="gider">T√ºr: Gider</option>
          </select>
          <select id="f-status">
            <option value="all">Durum: Hepsi</option>
            <option value="paid">Durum: √ñdendi/Alƒ±ndƒ±</option>
            <option value="pending">Durum: Bekliyor</option>
          </select>
          <select id="f-sort">
            <option value="none">Sƒ±rala: Yok</option>
            <option value="amt_desc">Tutar ‚Üì</option>
            <option value="amt_asc">Tutar ‚Üë</option>
            <option value="name_asc">ƒ∞sim A-Z</option>
            <option value="day_asc">G√ºn ‚Üë</option>
          </select>
          <button class="btn primary" type="button" onclick="applyFilters()">Uygula</button>
        </div>

        <div class="progress-text">
          <div id="progress-text">HARCAMA ORANI: %0</div>
          <div style="font-size:10px; font-weight:700; color:var(--text-dim);" id="month-hint"></div>
        </div>
        <div class="bar"><div id="progress-fill"></div></div>
      </div>

      <div id="entries-container"></div>

      <button class="add-btn" type="button" onclick="addRow()">+ Yeni ƒ∞≈ülem Ekle</button>

      <div class="summary-grid">
        <div class="stat-item"><small>GELƒ∞R</small><div id="t-inc" style="color:var(--income);">0 TL</div></div>
        <div class="stat-item"><small>Gƒ∞DER</small><div id="t-exp" style="color:var(--expense);">0 TL</div></div>
        <div class="stat-item"><small>BEKLEYEN</small><div id="t-pend" style="color:var(--pending);">0 TL</div></div>
        <div class="stat-item stat-net"><small>NET KALAN</small><div id="t-net">0 TL</div></div>
      </div>
    </div>
  </div>

  <div class="calendar-section">
    <div style="font-weight:800; font-size:0.9rem;">üìÖ √ñdeme Takvimi</div>
    <div class="calendar-grid" id="calendar-body"></div>
  </div>

  <div class="footer-copyright">umtdvr</div>

  <!-- CHART MODAL -->
  <div id="chartModal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close-x" type="button" onclick="closeModal('chartModal')">√ó</button>
      <h3 style="margin:0 0 10px 0;">Genel B√ºt√ße Daƒüƒ±lƒ±mƒ±</h3>
      <div class="chart-wrap">
        <canvas id="budgetChart"></canvas>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div id="settingsModal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close-x" type="button" onclick="closeModal('settingsModal')">√ó</button>
      <h3 style="margin:0 0 10px 0;">Ayarlar</h3>

      <div style="font-size:11px; font-weight:800; color:var(--text-dim); margin-bottom:8px;">√ñDEME G√úNLERƒ∞</div>
      <div id="settings-list"></div>

      <div class="danger-box">
        <div style="color:#991b1b; font-size:11px; font-weight:900;">KRƒ∞Tƒ∞K</div>
        <div style="color:#b91c1c; font-size:10px; font-weight:700; margin-top:4px;">
          T√ºm aylara ait veriler kalƒ±cƒ± silinir. Geri alƒ±namaz.
        </div>
        <button class="btn danger" style="width:100%; margin-top:10px;" type="button" onclick="hardResetData()">T√ºm Verileri Sƒ±fƒ±rla</button>
      </div>
    </div>
  </div>

  <!-- YEARLY MODAL -->
  <div id="yearlyModal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close-x" type="button" onclick="closeModal('yearlyModal')">√ó</button>
      <h3 style="margin:0 0 10px 0;" id="yearly-title">Yƒ±llƒ±k √ñzet</h3>
      <div id="yearly-content"></div>
    </div>
  </div>

<script>
  // -------- CONFIG --------
  const CLIENT_ID = '874591165323-ktdp2ojebh4225v0335lvuk3pct8eraq.apps.googleusercontent.com';
  const SCOPES = 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile';
  const DRIVE_FILE_NAME = 'budget_data_v1.json';

  // -------- STATE --------
  let accessToken = null, driveFileId = null, myChart = null;
  const aylar = ["OCAK","≈ûUBAT","MART","Nƒ∞SAN","MAYIS","HAZƒ∞RAN","TEMMUZ","AƒûUSTOS","EYL√úL","EKƒ∞M","KASIM","ARALIK"];
  let viewDate = new Date(), entries = [];
  let filterState = { q:'', type:'all', status:'all', sort:'none' };

  // Emoji ikonlar
  const iconMap = {
    'maa≈ü':'üí∞','kira':'üè†','market':'üõí','fatura':'üìÑ','elektrik':'‚ö°','su':'üíß','doƒüalgaz':'üî•',
    'internet':'üåê','telefon':'üì±','akaryakƒ±t':'‚õΩ','araba':'üöó','altƒ±n':'ü™ô','kredi':'üí≥','yemek':'üçî'
  };
  function getIcon(n){
    n = (n || "").toLowerCase();
    for (let k in iconMap) if (n.includes(k)) return iconMap[k];
    return 'üëõ';
  }

  // -------- GOOGLE DRIVE --------
  function handleAuthClick(){
    google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: async (res) => {
        if (res.error) { showToast("Giri≈ü Hatasƒ±!", "error"); return; }
        accessToken = res.access_token;

        document.getElementById('auth_btn').style.display = 'none';
        document.getElementById('auth_controls').style.display = 'flex';

        await fetchUserInfo();
        await initDriveFile();
        showToast("Baƒülantƒ± Ba≈üarƒ±lƒ±", "success");
      }
    }).requestAccessToken();
  }

  async function fetchUserInfo(){
    try{
      const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
        headers: { 'Authorization': `Bearer ${accessToken}` }
      });
      const user = await res.json();
      if (user?.email){
        document.getElementById('user-email').innerText = user.email;
        document.getElementById('user-img').src = user.picture || '';
        document.getElementById('user-info').style.display = 'flex';
      }
    }catch{}
  }

  async function driveRequest(url, opts={}){
    const res = await fetch(url, {
      ...opts,
      headers: {
        ...(opts.headers||{}),
        'Authorization': `Bearer ${accessToken}`
      }
    });
    if (!res.ok){
      const t = await res.text().catch(()=> '');
      throw new Error(`DRIVE_ERROR ${res.status} ${t.slice(0,140)}`);
    }
    const ct = res.headers.get('content-type') || '';
    if (ct.includes('application/json')) return await res.json();
    return await res.text();
  }

  async function initDriveFile(){
    const q = encodeURIComponent(`name="${DRIVE_FILE_NAME}" and trashed=false`);
    const listUrl = `https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&q=${q}&fields=files(id,name,modifiedTime)`;
    const data = await driveRequest(listUrl);
    if (data.files?.length){
      driveFileId = data.files[0].id;
      await syncFromDrive();
      return;
    }
    // create empty file
    const createUrl = `https://www.googleapis.com/drive/v3/files?fields=id`;
    const created = await driveRequest(createUrl, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ name: DRIVE_FILE_NAME, parents:['appDataFolder'], mimeType:'application/json' })
    });
    driveFileId = created.id;
    await syncToDrive();
  }

  async function syncToDrive(){
    if (!driveFileId || !accessToken) return;
    const allData = {};
    for (let i=0; i<localStorage.length; i++){
      const key = localStorage.key(i);
      if (key && key.startsWith("butce_")){
        allData[key] = JSON.parse(localStorage.getItem(key));
      }
    }
    const upUrl = `https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=media`;
    await driveRequest(upUrl, {
      method:'PATCH',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(allData)
    });
    showToast("Yedeklendi", "success");
  }

  async function syncFromDrive(){
    if (!driveFileId || !accessToken) return;
    const url = `https://www.googleapis.com/drive/v3/files/${driveFileId}?alt=media`;
    const driveData = await driveRequest(url);
    const obj = (typeof driveData === 'string') ? JSON.parse(driveData || '{}') : driveData;
    Object.keys(obj || {}).forEach(k => localStorage.setItem(k, JSON.stringify(obj[k])));
    loadData();
    showToast("E≈üitlendi", "info");
  }

  function handleLogout(){
    location.reload();
  }

  // -------- CORE --------
  function loadData(){
    const key = `butce_${aylar[viewDate.getMonth()]}_${viewDate.getFullYear()}`;
    const stored = localStorage.getItem(key);
    entries = stored ? JSON.parse(stored) : [{ name:'', amount:0, type:'gelir', status:'pending', billDay:1 }];
    renderAll();
  }

  function saveData(){
    const key = `butce_${aylar[viewDate.getMonth()]}_${viewDate.getFullYear()}`;
    localStorage.setItem(key, JSON.stringify(entries));
  }

  function renderAll(){
    document.getElementById('display-month').innerText = `${aylar[viewDate.getMonth()]} ${viewDate.getFullYear()}`;
    document.getElementById('month-hint').innerText = `Kayƒ±t: ${entries.length} i≈ülem`;
    renderRows();
    calculate();
    renderCalendar();
    renderSettings(); // ayarlar listesi g√ºncel kalsƒ±n
  }

  function applyFilters(){
    filterState.q = (document.getElementById('f-q').value || '').trim().toLowerCase();
    filterState.type = document.getElementById('f-type').value;
    filterState.status = document.getElementById('f-status').value;
    filterState.sort = document.getElementById('f-sort').value;
    renderRows();
  }

  function getViewEntries(){
    let list = entries.slice();

    if (filterState.q){
      list = list.filter(e => (e.name||'').toLowerCase().includes(filterState.q));
    }
    if (filterState.type !== 'all'){
      list = list.filter(e => e.type === filterState.type);
    }
    if (filterState.status !== 'all'){
      list = list.filter(e => e.status === filterState.status);
    }

    if (filterState.sort === 'amt_desc') list.sort((a,b)=>(b.amount||0)-(a.amount||0));
    if (filterState.sort === 'amt_asc') list.sort((a,b)=>(a.amount||0)-(b.amount||0));
    if (filterState.sort === 'name_asc') list.sort((a,b)=>(a.name||'').localeCompare((b.name||''),'tr'));
    if (filterState.sort === 'day_asc') list.sort((a,b)=>(a.billDay||0)-(b.billDay||0));

    return list;
  }

  function renderRows(){
    const container = document.getElementById('entries-container');
    container.innerHTML = '';

    const viewList = getViewEntries();

    viewList.forEach((item) => {
      const index = entries.indexOf(item);
      const row = document.createElement('div');
      row.className = 'entry-row';

      const isG = item.type === 'gelir';
      const sL = isG ? (item.status === 'paid' ? 'ALINDI' : 'BEKLE') : (item.status === 'paid' ? '√ñDENDƒ∞' : 'BEKLE');
      const sC = isG ? (item.status === 'paid' ? 'badge-received' : 'badge-awaiting') : (item.status === 'paid' ? 'badge-paid' : 'badge-pending');

      row.innerHTML = `
        <div class="icon-box" id="icon-box-${index}">${getIcon(item.name)}</div>
        <input type="text" value="${escapeHtml(item.name)}" placeholder="ƒ∞≈ülem"
          oninput="updateItem(${index}, 'name', this.value); document.getElementById('icon-box-${index}').innerText=getIcon(this.value)">
        <input type="number" value="${item.amount || ''}" placeholder="0" oninput="updateItem(${index}, 'amount', this.value)">
        <select onchange="updateItem(${index}, 'type', this.value); renderAll();">
          <option value="gelir" ${isG?'selected':''}>Gelir</option>
          <option value="gider" ${!isG?'selected':''}>Gider</option>
        </select>

        <div class="status-badge ${sC}" onclick="toggleStatus(${index})">${sL}</div>

        <input class="hide-mobile" type="number" min="1" max="31" value="${item.billDay || 1}" title="√ñdeme g√ºn√º"
          oninput="updateItem(${index}, 'billDay', this.value)">

        <div class="mini" onclick="removeRow(${index})" title="Sil">√ó</div>
      `;
      container.appendChild(row);
    });
  }

  function calculate(){
    let inc = 0, exp = 0, pend = 0;
    entries.forEach(i => {
      const amt = Number(i.amount) || 0;
      if (i.type === 'gelir') inc += amt;
      else if (i.status === 'paid') exp += amt;
      else pend += amt;
    });

    const totalOut = exp + pend;
    document.getElementById('t-inc').innerText = inc.toLocaleString() + " TL";
    document.getElementById('t-exp').innerText = exp.toLocaleString() + " TL";
    document.getElementById('t-pend').innerText = pend.toLocaleString() + " TL";
    document.getElementById('t-net').innerText = (inc - totalOut).toLocaleString() + " TL";

    const perc = inc > 0 ? Math.min((totalOut / inc) * 100, 100) : 0;
    document.getElementById('progress-fill').style.width = perc + "%";
    document.getElementById('progress-text').innerText = `HARCAMA ORANI: %${perc.toFixed(1)}`;

    return { inc, exp, pend, net: (inc - totalOut) };
  }

  function generateYearlyReport(){
    showModal('yearlyModal');
    document.getElementById('yearly-title').innerText = `${viewDate.getFullYear()} Yƒ±llƒ±k √ñzet`;

    let html = `<table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border); font-size:12px;">AY</th>
          <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border); font-size:12px;">GELƒ∞R</th>
          <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border); font-size:12px;">Gƒ∞DER</th>
          <th style="text-align:left; padding:10px; border-bottom:1px solid var(--border); font-size:12px;">NET</th>
        </tr>
      </thead><tbody>`;

    let yGelir = 0, yGider = 0;
    const Y = viewDate.getFullYear();
    aylar.forEach(ay => {
      const data = JSON.parse(localStorage.getItem(`butce_${ay}_${Y}`)) || [];
      let mGelir = 0, mGider = 0;
      data.forEach(x => {
        const a = Number(x.amount) || 0;
        if (a > 0){
          if (x.type === 'gelir') mGelir += a;
          else mGider += a;
        }
      });
      yGelir += mGelir; yGider += mGider;
      html += `<tr>
        <td style="padding:10px; border-bottom:1px solid var(--border); font-size:12px; font-weight:800;">${ay}</td>
        <td style="padding:10px; border-bottom:1px solid var(--border); font-size:12px;">${mGelir.toLocaleString()} TL</td>
        <td style="padding:10px; border-bottom:1px solid var(--border); font-size:12px;">${mGider.toLocaleString()} TL</td>
        <td style="padding:10px; border-bottom:1px solid var(--border); font-size:12px; font-weight:800;">${(mGelir-mGider).toLocaleString()} TL</td>
      </tr>`;
    });

    html += `<tr style="background:var(--soft); font-weight:900;">
      <td style="padding:10px; border-top:1px solid var(--border);">TOPLAM</td>
      <td style="padding:10px; border-top:1px solid var(--border);">${yGelir.toLocaleString()} TL</td>
      <td style="padding:10px; border-top:1px solid var(--border);">${yGider.toLocaleString()} TL</td>
      <td style="padding:10px; border-top:1px solid var(--border);">${(yGelir-yGider).toLocaleString()} TL</td>
    </tr></tbody></table>`;

    document.getElementById('yearly-content').innerHTML = html;
  }

  function exportPDF(){
    const element = document.querySelector('.budget-card');
    const opt = {
      margin: 10,
      filename: `Butce_${aylar[viewDate.getMonth()]}_${viewDate.getFullYear()}.pdf`,
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4' }
    };
    html2pdf().set(opt).from(element).save();
  }

  function showChart(){
    showModal('chartModal');
    const ctx = document.getElementById('budgetChart').getContext('2d');
    if (myChart) myChart.destroy();

    const stats = calculate();
    const labels = ["√ñdenen Gider", "Bekleyen Gider", "Net Kalan"];
    const data = [stats.exp, stats.pend, Math.max(0, stats.net)];

    myChart = new Chart(ctx, {
      type:'doughnut',
      data:{ labels, datasets:[{ data, backgroundColor:['#f43f5e','#f59e0b','#22c55e'] }] },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ position:'bottom' } },
        cutout:'62%'
      }
    });
  }

  function updateItem(i, k, v){
    if (!entries[i]) return;
    entries[i][k] = (k === 'amount' || k === 'billDay') ? (parseFloat(v) || 0) : v;
    if (k === 'billDay'){
      const max = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 0).getDate();
      entries[i].billDay = Math.min(Math.max(entries[i].billDay || 1, 1), max);
    }
    saveData();
    calculate();
    if (k === 'billDay' || k === 'name') renderCalendar();
  }

  function removeRow(i){
    entries.splice(i, 1);
    if (entries.length === 0) entries = [{ name:'', amount:0, type:'gider', status:'pending', billDay:1 }];
    saveData();
    renderAll();
    showToast("ƒ∞≈ülem silindi", "info");
  }

  function hardResetData(){
    const c1 = confirm("Dƒ∞KKAT: T√ºm aylara ait verileriniz silinecek. Emin misiniz?");
    if (!c1) return;
    const c2 = confirm("SON ONAY: Bu i≈ülem geri alƒ±namaz. Silinsin mi?");
    if (!c2) return;
    Object.keys(localStorage).forEach(k => { if (k.startsWith("butce_")) localStorage.removeItem(k); });
    location.reload();
  }

  function renderCalendar(){
    const body = document.getElementById('calendar-body');
    body.innerHTML = '';
    const days = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 0).getDate();

    for (let d=1; d<=days; d++){
      const dayDiv = document.createElement('div');
      dayDiv.className = 'cal-day';
      dayDiv.innerHTML = `<span>${d}</span>`;

      entries
        .filter(e => e.type === 'gider' && Number(e.billDay) === d)
        .forEach(ev => {
          const div = document.createElement('div');
          div.className = 'cal-ev';
          div.style.background = ev.status === 'paid' ? '#dcfce7' : '#fef3c7';
          div.style.color = ev.status === 'paid' ? '#166534' : '#92400e';
          div.innerText = `${getIcon(ev.name)} ${ev.name || 'ƒ∞simsiz'}`;
          dayDiv.appendChild(div);
        });

      body.appendChild(dayDiv);
    }
  }

  function renderSettings(){
    const list = document.getElementById('settings-list');
    if (!list) return;
    list.innerHTML = '';
    entries.filter(e => e.type === 'gider').forEach((item) => {
      const idx = entries.indexOf(item);
      const div = document.createElement('div');
      div.className = 'settings-row';
      div.innerHTML = `
        <div style="font-size:12px; font-weight:800;">
          ${getIcon(item.name)} ${escapeHtml(item.name || 'ƒ∞simsiz')}
        </div>
        <input type="number" value="${item.billDay || 1}" min="1" max="31"
          oninput="updateItem(${idx}, 'billDay', this.value)"
          style="width:70px; text-align:center;">
      `;
      list.appendChild(div);
    });
  }

  function toggleStatus(i){
    if (!entries[i]) return;
    entries[i].status = entries[i].status === 'paid' ? 'pending' : 'paid';
    updateItem(i, 'status', entries[i].status);
    renderAll();
  }

  function addRow(){
    entries.push({ name:'', amount:0, type:'gider', status:'pending', billDay:1 });
    saveData();
    renderAll();
  }

  function changeMonth(step){
    viewDate.setMonth(viewDate.getMonth() + step);
    loadData();
  }

  function toggleTheme(){
    const t = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', t);
  }

  function toggleSearch(){
    const p = document.getElementById('search-panel');
    const isOpen = p.style.display === 'grid';
    p.style.display = isOpen ? 'none' : 'grid';
  }

  function showModal(id){ document.getElementById(id).style.display = 'flex'; }
  function closeModal(id){ document.getElementById(id).style.display = 'none'; }

  function showToast(m, type='info'){
    const t = document.createElement('div');
    t.className = `toast-msg toast-${type}`;
    t.innerText = m;
    document.body.appendChild(t);
    setTimeout(() => t.classList.add('show'), 60);
    setTimeout(() => { t.classList.remove('show'); setTimeout(()=>t.remove(), 350); }, 2600);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  window.onload = () => {
    // Tema varsayƒ±lan light
    if (!document.body.getAttribute('data-theme')) document.body.setAttribute('data-theme', 'light');

    // filtre UI default
    document.getElementById('f-q').addEventListener('input', () => {});
    loadData();
  };
</script>
</body>
</html>
